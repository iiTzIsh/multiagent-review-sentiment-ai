{% extends 'base/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Hotel Review Analytics{% endblock %}

{% block page_icon %}<i class="fas fa-chart-bar me-2"></i>{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}

{% block page_description %}
<p class="page-description">Comprehensive review analytics and insights</p>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2 flex-wrap">
    <button id="generate-ai-analysis-btn" class="btn btn-warning btn-lg" data-bs-toggle="tooltip" title="Generate comprehensive AI analysis including summary, tags, and insights">
        <i class="fas fa-brain me-2"></i>Generate AI Analysis
    </button>
    <a href="{% url 'dashboard:upload_reviews' %}" class="btn btn-primary" data-bs-toggle="tooltip" title="Upload new review data">
        <i class="fas fa-upload me-1"></i>Upload Reviews
    </a>
    <button id="process-reviews-btn" class="btn btn-success" data-bs-toggle="tooltip" title="Process uploaded reviews with AI">
        <i class="fas fa-cog me-1"></i>Process Reviews
    </button>
    <button id="refresh-analytics-btn" class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Refresh analytics data">
        <i class="fas fa-sync-alt me-1"></i>Refresh
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Modern Card Header Styles for Analytics Page */
    .card .card-header {
        background: #1e3a8a !important;
        border: none !important;
        color: white !important;
        padding: 1rem 1.25rem !important;
        border-radius: 12px 12px 0 0 !important;
    }

    /* Alternate header colors in professional blues and teals */
    .card:nth-child(3n+1) .card-header {
        background: #1e3a8a !important; /* Professional dark blue */
    }

    .card:nth-child(3n+2) .card-header {
        background: #0f766e !important; /* Teal green */
    }

    .card:nth-child(3n+3) .card-header {
        background: #1e40af !important; /* Royal blue */
    }

    /* Additional professional variations */
    .card:nth-child(6n+4) .card-header {
        background: #0369a1 !important; /* Sky blue */
    }

    .card:nth-child(6n+5) .card-header {
        background: #115e59 !important; /* Dark teal */
    }

    .card:nth-child(6n+6) .card-header {
        background: #1d4ed8 !important; /* Bright blue */
    }

    /* Ensure header text and elements are always white and visible */
    .card .card-header *,
    .card .card-header h1,
    .card .card-header h2,
    .card .card-header h3,
    .card .card-header h4,
    .card .card-header h5,
    .card .card-header h6,
    .card .card-header .card-title,
    .card .card-header span,
    .card .card-header p,
    .card .card-header i,
    .card .card-header .fas,
    .card .card-header .far,
    .card .card-header .fab {
        color: white !important;
    }

    .card .card-header .btn-outline-secondary {
        border-color: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
    }

    .card .card-header .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
    }

    .card .card-header .btn-outline-light {
        border-color: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
    }

    .card .card-header .btn-outline-light:hover,
    .card .card-header .btn-outline-light.active {
        background-color: rgba(255, 255, 255, 0.2) !important;
        border-color: rgba(255, 255, 255, 0.8) !important;
        color: white !important;
    }

    /* Make sure card bodies still have proper dark theme styling */
    .card .card-body {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }

    /* Enhanced Sentiment Analysis Styles */
    .sentiment-score {
        padding: 1rem;
    }

    .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        border: 3px solid;
    }

    .score-circle .score-number {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .sentiment-score.positive .score-circle {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .sentiment-score.neutral .score-circle {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    .sentiment-score.negative .score-circle {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    /* Keyword Cloud Styles */
    .keyword-cloud {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .keyword-cloud.positive {
        background: rgba(40, 167, 69, 0.1);
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .keyword-cloud.negative {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .keyword-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        margin: 0.25rem;
        border-radius: 20px;
        font-weight: 500;
        transition: transform 0.2s ease;
        cursor: pointer;
    }

    .keyword-tag:hover {
        transform: scale(1.05);
    }

    .keyword-cloud.positive .keyword-tag {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .keyword-cloud.negative .keyword-tag {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .keyword-tag.large {
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
    }

    .keyword-tag.medium {
        font-size: 1rem;
        padding: 0.375rem 0.875rem;
    }

    .keyword-tag.small {
        font-size: 0.875rem;
        padding: 0.25rem 0.625rem;
    }

    /* Topic Cards */
    .topic-card {
        text-align: center;
        padding: 1.5rem 1rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .topic-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .topic-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .topic-icon i {
        font-size: 1.5rem;
    }

    .topic-score {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0.5rem 0;
    }

    .topic-score.positive {
        color: #28a745;
    }

    .topic-score.negative {
        color: #dc3545;
    }

    /* Actionable Insights Styles */
    .insights-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .insight-item {
        display: flex;
        align-items: flex-start;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-left: 4px solid;
        transition: transform 0.2s ease;
    }

    .insight-item:hover {
        transform: translateX(2px);
    }

    .insight-item.urgent {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .insight-item.important {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }

    .insight-item.moderate {
        border-left-color: #17a2b8;
        background: rgba(23, 162, 184, 0.1);
    }

    .insight-item.success {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .insight-priority {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 1rem;
        margin-top: 0.5rem;
        flex-shrink: 0;
    }

    /* AI Summary Styles */
    .ai-summary-text .summary-content {
        background: rgba(13, 110, 253, 0.1);
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        line-height: 1.7;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .insights-list {
        list-style: none;
        padding: 0;
    }

    .insights-list li {
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        background: rgba(23, 162, 184, 0.1);
        border: 1px solid rgba(23, 162, 184, 0.2);
        border-radius: 8px;
        border-left: 4px solid #17a2b8;
        transition: transform 0.2s ease;
    }

    .insights-list li:hover {
        transform: translateX(2px);
    }

    .recommendations-list .recommendation-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.2);
        border-radius: 8px;
        border-left: 4px solid #ffc107;
        transition: transform 0.2s ease;
    }

    .recommendations-list .recommendation-item:hover {
        transform: translateX(2px);
    }

    .recommendations-list .recommendation-item::before {
        content: '💡';
        margin-right: 0.5rem;
    }

    .insight-priority.high {
        background: #dc3545;
    }

    .insight-priority.medium {
        background: #ffc107;
    }

    .insight-priority.low {
        background: #17a2b8;
    }

    .insight-priority.success {
        background: #28a745;
    }

    .insight-content {
        flex-grow: 1;
    }

    .insight-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .insight-desc {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .insight-action {
        color: var(--text-muted);
        font-size: 0.8rem;
    }

    .insight-impact {
        margin-left: 1rem;
        align-self: flex-start;
    }

    /* Enhanced Metric Cards */
    .metric-card {
        border-radius: 12px;
        padding: 1.5rem;
        border: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 140px; /* Fixed height for all cards */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.875rem;
        opacity: 0.9;
        font-weight: 500;
    }

    /* Stars Rating */
    .stars i {
        font-size: 0.75rem;
    }

    /* Emerging Topics Styles */
    .emerging-topic-card {
        background: #ffffff !important;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .emerging-topic-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: #3b82f6;
    }

    .emerging-topic-card .topic-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }

    .emerging-topic-card .topic-content {
        flex: 1;
    }

    .emerging-topic-card .topic-content h6 {
        margin: 0 0 0.25rem 0;
        font-weight: 600;
        color: #1f2937 !important;
        font-size: 1.1rem !important;
    }

    .emerging-topic-card .topic-content small {
        color: #6b7280 !important;
        font-size: 0.875rem;
    }

    .emerging-topic-card .topic-badge .badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
    }

    /* Issues List Styles */
    .issues-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .issue-item {
        background: #ffffff !important;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }

    .issue-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .issue-item .issue-priority {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .issue-item .issue-priority.high {
        background: #dc2626;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
    }

    .issue-item .issue-priority.medium {
        background: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }

    .issue-item .issue-priority.low {
        background: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .issue-item .issue-content {
        flex: 1;
    }

    .issue-item .issue-title {
        font-weight: 600;
        color: #1f2937 !important;
        margin-bottom: 0.25rem;
        font-size: 1.1rem !important;
    }

    .issue-item .issue-desc {
        color: #6b7280 !important;
        font-size: 0.875rem;
    }

    .issue-item .issue-desc {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .issue-item .issue-impact .badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .keyword-cloud {
            text-align: center;
        }
        
        .topic-card {
            margin-bottom: 1rem;
        }
        
        .insight-item {
            flex-direction: column;
            text-align: center;
        }
        
        .insight-priority {
            margin: 0 auto 0.5rem;
        }
        
        .insight-impact {
            margin: 0.5rem 0 0;
        }

        .emerging-topic-card,
        .issue-item {
            flex-direction: column;
            text-align: center;
            gap: 0.75rem;
        }

        .issue-item .issue-priority {
            margin: 0 auto;
        }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Add spacing between header and cards -->
            <div class="mb-5"></div>
            
            <!-- Enhanced Executive Summary Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-primary text-white fade-in">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ statistics.total_reviews|default:0 }}</div>
                                <div class="metric-label">Total Reviews</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-comments fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                <i class="fas fa-arrow-up me-1"></i>+12% from last month
                            </small>
                            <small class="opacity-75">
                                {{ date_range.start|date:"M j" }} - {{ date_range.end|date:"M j" }}
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-success text-white fade-in" style="animation-delay: 0.1s">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ statistics.average_score|default:0|floatformat:1 }}/5</div>
                                <div class="metric-label">Average Satisfaction</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-star fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                {% if statistics.average_score >= 4 %}
                                <i class="fas fa-arrow-up me-1"></i>Excellent Rating
                                {% elif statistics.average_score >= 3 %}
                                <i class="fas fa-minus me-1"></i>Good Rating
                                {% else %}
                                <i class="fas fa-arrow-down me-1"></i>Needs Improvement
                                {% endif %}
                            </small>
                            <small class="opacity-75">
                                {{ statistics.processing_rate|floatformat:1 }}% Processed
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-info text-white fade-in" style="animation-delay: 0.2s">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ statistics.positive_percentage|default:0|floatformat:0 }}%</div>
                                <div class="metric-label">Positive Sentiment</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-smile fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                <i class="fas fa-chart-line me-1"></i>+5% vs last period
                            </small>
                            <small class="opacity-75">
                                {{ statistics.negative_percentage|default:0|floatformat:0 }}% Negative
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-warning text-white fade-in" style="animation-delay: 0.3s">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ total_hotels|default:0 }}</div>
                                <div class="metric-label">Active Hotels</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-hotel fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                <i class="fas fa-clock me-1"></i>Real-time monitoring
                            </small>
                         
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI-Generated Summary Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-robot me-2"></i>AI-Powered Business Insights
                                </h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-light" onclick="refreshSummary()" data-bs-toggle="tooltip" title="Refresh AI analysis">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="btn btn-outline-light" onclick="exportSummary()" data-bs-toggle="tooltip" title="Export summary">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="aiSummaryContent">
                                <!-- This will be populated by JavaScript after processing -->
                                <div class="text-center text-muted py-4" id="noSummaryMessage">
                                    <i class="fas fa-magic fa-3x mb-3 opacity-50"></i>
                                    <h6>No AI Summary Available</h6>
                                    <p class="mb-3">Process some reviews to generate intelligent business insights powered by Google Gemini AI.</p>
                                    <button class="btn btn-success" onclick="processAllReviewsFromAnalytics()">
                                        <i class="fas fa-robot me-2"></i>Generate AI Analysis
                                    </button>
                                </div>
                            </div>
                            
                            <!-- AI Summary Template (hidden) -->
                            <div id="aiSummaryTemplate" style="display: none;">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="ai-summary-text">
                                            <h6 class="text-primary mb-3">
                                                <i class="fas fa-lightbulb me-2"></i>Executive Summary
                                            </h6>
                                            <div id="summaryText" class="summary-content">
                                                <!-- AI-generated summary will be inserted here -->
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <h6 class="text-info mb-3">
                                                <i class="fas fa-chart-line me-2"></i>Key Insights
                                            </h6>
                                            <ul id="keyInsights" class="insights-list">
                                                <!-- AI-generated insights will be inserted here -->
                                            </ul>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <div class="alert alert-primary border-0 shadow-sm" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 12px;">
                                                <div class="text-white">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <i class="fas fa-robot me-2 fs-5"></i>
                                                        <strong class="fs-6">AI Analysis Report</strong>
                                                    </div>
                                                    <div class="d-flex align-items-center mb-1">
                                                        <i class="fas fa-brain me-2 text-warning"></i>
                                                        <small class="text-white-50">Powered by Google Gemini AI</small>
                                                    </div>
                                                    <span id="analysisMetadata" class="text-white fw-medium" style="font-size: 0.875rem;">
                                                        <!-- Metadata will be inserted here -->
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="ai-recommendations">
                                            <h6 class="text-warning mb-3">
                                                <i class="fas fa-tasks me-2"></i>Recommendations
                                            </h6>
                                            <div id="recommendations" class="recommendations-list">
                                                <!-- AI-generated recommendations will be inserted here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Analytics Charts Row -->
            <div class="row mb-4">

            </div>

            <!-- Topic Analysis Row -->
            <div class="row mb-4">
                <!-- Topic & Theme Analysis -->
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-tags me-2"></i>Topic & Theme Analysis
                                </h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-light active" onclick="toggleTopicView('keywords')">
                                        Keywords
                                    </button>
                                    <button class="btn btn-outline-light" onclick="toggleTopicView('topics')">
                                        Topics
                                    </button>
                                    <button class="btn btn-outline-light" onclick="toggleTopicView('issues')">
                                        Issues
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Keyword Frequency Analysis -->
                            <div id="keywordAnalysis">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-success mb-3"><i class="fas fa-thumbs-up me-2"></i>Top Positive Keywords</h6>
                                        <div class="keyword-cloud positive">
                                            <span class="keyword-tag large">excellent</span>
                                            <span class="keyword-tag medium">clean</span>
                                            <span class="keyword-tag large">friendly</span>
                                            <span class="keyword-tag small">comfortable</span>
                                            <span class="keyword-tag medium">beautiful</span>
                                            <span class="keyword-tag large">perfect</span>
                                            <span class="keyword-tag small">amazing</span>
                                            <span class="keyword-tag medium">helpful</span>
                                            <span class="keyword-tag small">spacious</span>
                                            <span class="keyword-tag medium">convenient</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-danger mb-3"><i class="fas fa-thumbs-down me-2"></i>Top Negative Keywords</h6>
                                        <div class="keyword-cloud negative">
                                            <span class="keyword-tag large">dirty</span>
                                            <span class="keyword-tag medium">noise</span>
                                            <span class="keyword-tag large">rude</span>
                                            <span class="keyword-tag small">expensive</span>
                                            <span class="keyword-tag medium">old</span>
                                            <span class="keyword-tag large">broken</span>
                                            <span class="keyword-tag small">slow</span>
                                            <span class="keyword-tag medium">uncomfortable</span>
                                            <span class="keyword-tag small">smelly</span>
                                            <span class="keyword-tag medium">disappointing</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Topic Breakdown -->
                                <div class="row mt-4">
                                    <div class="col-md-3">
                                        <div class="topic-card service">
                                            <div class="topic-icon">
                                                <i class="fas fa-concierge-bell"></i>
                                            </div>
                                            <h6>Service</h6>
                                            <div class="topic-score positive">85%</div>
                                            <small class="text-muted">Staff, Support, Help</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="topic-card cleanliness">
                                            <div class="topic-icon">
                                                <i class="fas fa-broom"></i>
                                            </div>
                                            <h6>Cleanliness</h6>
                                            <div class="topic-score positive">78%</div>
                                            <small class="text-muted">Clean, Hygiene, Tidy</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="topic-card location">
                                            <div class="topic-icon">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </div>
                                            <h6>Location</h6>
                                            <div class="topic-score positive">92%</div>
                                            <small class="text-muted">Area, Transport, Access</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="topic-card value">
                                            <div class="topic-icon">
                                                <i class="fas fa-dollar-sign"></i>
                                            </div>
                                            <h6>Value</h6>
                                            <div class="topic-score negative">62%</div>
                                            <small class="text-muted">Price, Cost, Worth</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actionable Insights & Hotel Performance -->
            <div class="row mb-4">
                <!-- Actionable Insights Dashboard -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Actionable Insights & Recommendations
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Priority Issues -->
                                <div class="col-md-6">
                                    <h6 class="text-danger mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Priority Issues
                                    </h6>
                                    <div class="insights-list">
                                        <div class="insight-item urgent">
                                            <div class="insight-priority high"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Slow WiFi Complaints</div>
                                                <div class="insight-desc">15 mentions in last 7 days</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Contact IT support immediately</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-danger">High Impact</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item important">
                                            <div class="insight-priority medium"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Housekeeping Issues</div>
                                                <div class="insight-desc">8 cleanliness complaints</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Review cleaning protocols</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-warning">Medium Impact</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item moderate">
                                            <div class="insight-priority low"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Breakfast Variety</div>
                                                <div class="insight-desc">3 suggestions for more options</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Consider menu expansion</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-info">Low Impact</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Success Stories -->
                                <div class="col-md-6">
                                    <h6 class="text-success mb-3">
                                        <i class="fas fa-trophy me-2"></i>Success Stories
                                    </h6>
                                    <div class="insights-list">
                                        <div class="insight-item success">
                                            <div class="insight-priority success"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Exceptional Front Desk</div>
                                                <div class="insight-desc">25 positive mentions this week</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Recognize and replicate practices</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-success">Keep It Up!</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item success">
                                            <div class="insight-priority success"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Perfect Location</div>
                                                <div class="insight-desc">92% positive location feedback</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Highlight in marketing</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-success">Marketing Asset</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item success">
                                            <div class="insight-priority success"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Room Comfort</div>
                                                <div class="insight-desc">Consistent 4.5+ star ratings</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Use as selling point</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-success">Competitive Edge</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Hotels Performance -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-trophy me-2"></i>Hotel Performance
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for hotel in top_hotels %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ hotel.name|truncatechars:25 }}</h6>
                                            <small class="text-muted">
                                                <i class="fas fa-map-marker-alt"></i> {{ hotel.city|default:"Location N/A" }}
                                            </small>
                                            <div class="mt-1">
                                                <div class="d-flex align-items-center">
                                                    <div class="stars me-2">
                                                        {% for i in "12345" %}
                                                            <i class="fas fa-star {% if forloop.counter <= hotel.avg_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                                        {% endfor %}
                                                    </div>
                                                    <small class="text-muted">{{ hotel.avg_rating|floatformat:1 }}/5</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-primary rounded-pill mb-1">
                                                {{ hotel.review_count }} reviews
                                            </span>
                                            {% if hotel.sentiment_trend > 0 %}
                                                <br><small class="text-success"><i class="fas fa-arrow-up"></i> +{{ hotel.sentiment_trend }}%</small>
                                            {% elif hotel.sentiment_trend < 0 %}
                                                <br><small class="text-danger"><i class="fas fa-arrow-down"></i> {{ hotel.sentiment_trend }}%</small>
                                            {% else %}
                                                <br><small class="text-muted"><i class="fas fa-minus"></i> No change</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center text-muted py-4">
                                    <i class="fas fa-hotel fa-2x mb-2"></i>
                                    <p class="mb-0">No hotel data available</p>
                                    <small>Upload reviews to see performance data</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Analytics Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="csv">CSV (Comma Separated)</option>
                            <option value="excel">Excel Spreadsheet</option>
                            <option value="json">JSON Data</option>
                            <option value="pdf">PDF Report</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportDateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="exportDateRange">
                            <option value="current">Current Period ({{ date_range.days }} days)</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 3 Months</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">
                                Include Charts and Visualizations
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeRawData">
                            <label class="form-check-label" for="includeRawData">
                                Include Raw Review Data
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performExport()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart data as JSON -->
{{ sentiment_chart|json_script:"sentiment-data" }}
{{ score_distribution|json_script:"score-data" }}
{{ daily_trends|json_script:"trends-data" }}
{{ hotel_performance|json_script:"hotel-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let sentimentChart, scoreChart, trendsChart;
let currentSentimentView = 'intensity';
let currentTopicView = 'keywords';
let currentTrendView = 'sentiment';

// Get chart data from JSON scripts
function getSafeJsonData(elementId) {
    const element = document.getElementById(elementId);
    if (element && element.textContent) {
        try {
            return JSON.parse(element.textContent);
        } catch (e) {
            console.warn('Failed to parse JSON data for', elementId);
            return null;
        }
    }
    return null;
}

const sentimentData = getSafeJsonData('sentiment-data') || { positive: 0, negative: 0, neutral: 0 };
const scoreData = getSafeJsonData('score-data') || [];
const trendsData = getSafeJsonData('trends-data') || [];
const hotelData = getSafeJsonData('hotel-data') || [];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedAnalyticsCharts();
    initializeFilters();
    initializeKeywordInteractions();
    initializeInsightInteractions();
    
    // Load existing AI analysis on page load
    loadExistingAIAnalysis();
    
    // Add event listener for Generate AI Analysis button
    const generateAIButton = document.getElementById('generate-ai-analysis-btn');
    if (generateAIButton) {
        generateAIButton.addEventListener('click', generateCompleteAIAnalysis);
    }
    
    // Add event listener for Refresh button
    const refreshButton = document.getElementById('refresh-analytics-btn');
    if (refreshButton) {
        refreshButton.addEventListener('click', refreshAnalytics);
    }
});

// AI Analysis Functions - Load Existing & On-Demand Generation

function loadExistingAIAnalysis() {
    console.log('Checking for existing AI analysis...');
    
    // Check if there's existing analysis
    fetch('/api/v1/get-ai-analysis/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.has_existing_analysis) {
            console.log('Found existing AI analysis, displaying...');
            
            // Transform data to match the format expected by display functions
            const transformedData = {
                summary: data.analysis.summary,
                tags_analysis: data.analysis.tags_analysis,
                generated_at: data.analysis.generated_at,
                processed_reviews: data.analysis.summary.total_reviews
            };
            
            // Display existing analysis
            displayAISummary(transformedData);
            displayAITagsAnalysis(transformedData.tags_analysis);
            
            // Update button text to indicate regeneration
            const generateBtn = document.getElementById('generate-ai-analysis-btn');
            if (generateBtn) {
                generateBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Regenerate AI Analysis';
                generateBtn.title = 'Click to regenerate AI analysis with latest data';
            }
            
            console.log('Existing AI analysis loaded successfully');
        } else {
            console.log('No existing AI analysis found');
            // Keep the default "Generate AI Analysis" button text
        }
    })
    .catch(error => {
        console.error('Error loading existing AI analysis:', error);
        // Don't show error to user - just continue without existing analysis
    });
}

function generateCompleteAIAnalysis() {
    const button = document.getElementById('generate-ai-analysis-btn');
    
    if (!button) return;
    
    // Show loading state
    setButtonLoading(button, true);
    showProcessingOverlay('Generating comprehensive AI analysis...<br><small>This includes summary, tags, topics, and insights using Google Gemini AI</small>');
    
    // Get CSRF token with null safety
    const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
    
    // Make combined API call
    fetch('/api/v1/ai-analysis/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            days: 30  // Can be made configurable
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingOverlay();
        setButtonLoading(button, false);
        
        if (data.status === 'success') {
            // Display summary
            displayAISummary(data);
            
            // Display tags analysis
            displayAITagsAnalysis(data.tags_analysis);
            
            // Show success message
            showToast('success', `AI analysis completed! Processed ${data.processed_reviews} reviews with advanced insights.`);
            
            // Update button text to indicate completion and enable regeneration
            updateButtonSuccess(button);
            
            // Change button text to indicate regeneration capability
            setTimeout(() => {
                button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Regenerate AI Analysis';
                button.title = 'Click to regenerate AI analysis with latest data';
                button.disabled = false;
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            }, 2000);
            
        } else if (data.status === 'no_data') {
            showToast('warning', data.message);
            setButtonDisabled(button, 'No Data Available');
        } else {
            showToast('error', data.error_message || 'AI analysis generation failed');
        }
    })
    .catch(error => {
        hideProcessingOverlay();
        setButtonLoading(button, false);
        showToast('error', 'Failed to generate AI analysis. Please try again.');
        console.error('AI Analysis Error:', error);
    });
}

function processAllReviewsFromAnalytics() {
    if (!confirm('This will process all unprocessed reviews and generate an AI-powered summary. This may take several minutes. Continue?')) {
        return;
    }
    
    showProcessingOverlay('Processing reviews with AI agents and generating business insights...');
    
    fetch('{% url "dashboard:process_reviews" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            batch_size: 100,
            generate_summary: true
        })
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingOverlay();
        
        if (data.success) {
            showToast('success', `Successfully processed ${data.processed_count} reviews!`);
            
            if (data.summary_generated) {
                // Refresh the summary display
                setTimeout(() => {
                    loadExistingSummary();
                }, 1000);
                
                showToast('success', 'AI-powered business summary generated!');
            }
        } else {
            showToast('error', data.error || 'Processing failed');
        }
    })
    .catch(error => {
        hideProcessingOverlay();
        showToast('error', 'Processing request failed');
        console.error('Error:', error);
    });
}

function displayAISummary(data) {
    const noSummaryMessage = document.getElementById('noSummaryMessage');
    const summaryTemplate = document.getElementById('aiSummaryTemplate');
    
    if (noSummaryMessage) {
        noSummaryMessage.style.display = 'none';
    }
    
    if (summaryTemplate && data.summary) {
        // Clone the template
        const summaryContent = summaryTemplate.cloneNode(true);
        summaryContent.id = 'aiSummaryActive';
        summaryContent.style.display = 'block';
        
        // Populate the summary text
        const summaryTextElement = summaryContent.querySelector('#summaryText');
        if (summaryTextElement && data.summary.text) {
            summaryTextElement.innerHTML = data.summary.text.replace(/\n/g, '<br>');
        }
        
        // Populate insights if available
        const insightsElement = summaryContent.querySelector('#keyInsights');
        if (insightsElement && data.insights) {
            const insights = data.insights.sentiment_percentages ? 
                Object.entries(data.insights.sentiment_percentages).map(([key, value]) => 
                    `${key}: ${value.toFixed(1)}%`
                ) : [];
            
            insightsElement.innerHTML = insights.map(insight => `<li>${insight}</li>`).join('');
        }
        
        // Populate AI-generated recommendations
        const recommendationsElement = summaryContent.querySelector('#recommendations');
        if (recommendationsElement) {
            let recommendations = [];
            
            // Get recommendations from the data
            if (data.summary && data.summary.recommendations) {
                recommendations = data.summary.recommendations;
            } else if (data.recommendations) {
                recommendations = data.recommendations;
            } else {
                // Fallback recommendations
                recommendations = [
                    "Monitor review trends weekly for early issue detection",
                    "Respond to all reviews promptly and professionally", 
                    "Focus on addressing most common customer complaints"
                ];
            }
            
            console.log('Displaying recommendations:', recommendations);
            
            recommendationsElement.innerHTML = recommendations.map(rec => {
                // Handle both string and object formats
                const recText = typeof rec === 'object' ? rec.text : rec;
                return `<div class="recommendation-item">${recText}</div>`;
            }).join('');
        }
        
        // Populate metadata
        const metadataElement = summaryContent.querySelector('#analysisMetadata');
        if (metadataElement && data.summary) {
            metadataElement.innerHTML = `
                <div class="d-flex flex-wrap gap-3 mt-1">
                    <span><i class="fas fa-chart-bar me-1 text-warning"></i><strong>${data.summary.total_reviews}</strong> reviews analyzed</span>
                    <span><i class="fas fa-star me-1 text-warning"></i>Avg Score: <strong>${data.summary.average_score}/5</strong></span>
                    <span><i class="fas fa-calendar me-1 text-warning"></i>Generated: <strong>${new Date().toLocaleDateString()}</strong></span>
                </div>
            `;
        }
        
        // Replace the content
        const aiSummaryContent = document.getElementById('aiSummaryContent');
        if (aiSummaryContent) {
            aiSummaryContent.innerHTML = '';
            aiSummaryContent.appendChild(summaryContent);
        }
    }
}

function refreshAnalytics() {
    // Simply regenerate the AI analysis
    generateCompleteAIAnalysis();
}

// Button Management Functions
function setButtonLoading(button, isLoading) {
    if (isLoading) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        button.classList.add('btn-secondary');
        button.classList.remove('btn-warning');
    } else {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-brain me-2"></i>Generate AI Analysis';
        button.classList.remove('btn-secondary');
        button.classList.add('btn-warning');
    }
}

function updateButtonSuccess(button) {
    button.innerHTML = '<i class="fas fa-check me-2"></i>Analysis Complete';
    button.classList.remove('btn-warning');
    button.classList.add('btn-success');
    
    // Reset after 3 seconds
    setTimeout(() => {
        button.innerHTML = '<i class="fas fa-brain me-2"></i>Regenerate Analysis';
        button.classList.remove('btn-success');
        button.classList.add('btn-warning');
    }, 3000);
}

function setButtonDisabled(button, text) {
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${text}`;
    button.classList.remove('btn-warning');
    button.classList.add('btn-secondary');
}

function displayAITagsAnalysis(tagsData) {
    // Update positive keywords
    const positiveKeywordsContainer = document.querySelector('.keyword-cloud.positive');
    if (positiveKeywordsContainer && tagsData.positive_keywords) {
        positiveKeywordsContainer.innerHTML = tagsData.positive_keywords.map((keyword, index) => {
            const size = index < 3 ? 'large' : (index < 6 ? 'medium' : 'small');
            return `<span class="keyword-tag ${size}">${keyword}</span>`;
        }).join('');
    }

    // Update negative keywords
    const negativeKeywordsContainer = document.querySelector('.keyword-cloud.negative');
    if (negativeKeywordsContainer && tagsData.negative_keywords) {
        negativeKeywordsContainer.innerHTML = tagsData.negative_keywords.map((keyword, index) => {
            const size = index < 3 ? 'large' : (index < 6 ? 'medium' : 'small');
            return `<span class="keyword-tag ${size}">${keyword}</span>`;
        }).join('');
    }

    // Update topic metrics
    if (tagsData.topic_metrics) {
        updateTopicCard('service', tagsData.topic_metrics.service);
        updateTopicCard('cleanliness', tagsData.topic_metrics.cleanliness);
        updateTopicCard('location', tagsData.topic_metrics.location);
        updateTopicCard('value', tagsData.topic_metrics.value);
    }

    // Store for other views (issues, topics)
    window.aiTagsData = tagsData;
}

function updateTopicCard(topicName, topicData) {
    const topicCard = document.querySelector(`.topic-card.${topicName}`);
    if (topicCard && topicData) {
        const scoreElement = topicCard.querySelector('.topic-score');
        const keywordsElement = topicCard.querySelector('small.text-muted');
        
        if (scoreElement) {
            scoreElement.textContent = `${topicData.percentage}%`;
            scoreElement.className = `topic-score ${topicData.percentage >= 70 ? 'positive' : 'negative'}`;
        }
        
        if (keywordsElement && topicData.keywords) {
            keywordsElement.textContent = topicData.keywords.join(', ');
        }
    }
}

function exportSummary() {
    // Simple export functionality
    const summaryText = document.querySelector('#summaryText')?.textContent || '';
    const insights = Array.from(document.querySelectorAll('#keyInsights li')).map(li => li.textContent).join('\n');
    const recommendations = Array.from(document.querySelectorAll('.recommendation-item')).map(item => item.textContent).join('\n');
    
    const exportContent = `AI-POWERED BUSINESS ANALYSIS REPORT
Generated: ${new Date().toLocaleDateString()}

EXECUTIVE SUMMARY:
${summaryText}

KEY INSIGHTS:
${insights}

RECOMMENDATIONS:
${recommendations}

Generated by Google Gemini AI via Hotel Review Analytics Platform
`;
    
    const blob = new Blob([exportContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-analysis-report-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function showProcessingOverlay(message) {
    let overlay = document.getElementById('processingOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'processingOverlay';
        overlay.innerHTML = `
            <div class="processing-content">
                <div class="spinner-border text-light mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-light" id="processingMessage">${message}</h5>
            </div>
        `;
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        document.body.appendChild(overlay);
    } else {
        document.getElementById('processingMessage').textContent = message;
        overlay.style.display = 'flex';
    }
}

function hideProcessingOverlay() {
    const overlay = document.getElementById('processingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function showToast(type, message) {
    // Simple toast implementation
    const toastContainer = document.getElementById('toastContainer') || (() => {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    })();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function initializeEnhancedAnalyticsCharts() {
    // Enhanced Sentiment Distribution Chart
    const sentimentCtx = document.getElementById('sentimentChart');
    if (sentimentCtx) {
        sentimentChart = new Chart(sentimentCtx, {
            type: 'doughnut',
            data: {
                labels: ['Very Positive', 'Positive', 'Neutral', 'Negative', 'Very Negative'],
                datasets: [{
                    data: [
                        Math.round((sentimentData.positive || 0) * 0.45),
                        Math.round((sentimentData.positive || 0) * 0.55),
                        sentimentData.neutral || 0,
                        Math.round((sentimentData.negative || 0) * 0.6),
                        Math.round((sentimentData.negative || 0) * 0.4)
                    ],
                    backgroundColor: [
                        '#22c55e',
                        '#16a34a', 
                        '#fbbf24',
                        '#f87171',
                        '#dc2626'
                    ],
                    borderWidth: 2,
                    borderColor: '#1f2937'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            color: '#e5e7eb',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} reviews (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Enhanced Score Distribution Chart
    const scoreCtx = document.getElementById('scoreChart');
    if (scoreCtx) {
        const scoreLabels = ['⭐', '⭐⭐', '⭐⭐⭐', '⭐⭐⭐⭐', '⭐⭐⭐⭐⭐'];
        const scoreValues = scoreData.length ? scoreData.map(item => item.count || 0) : [3, 7, 15, 30, 45];
        
        scoreChart = new Chart(scoreCtx, {
            type: 'bar',
            data: {
                labels: scoreLabels,
                datasets: [{
                    label: 'Number of Reviews',
                    data: scoreValues,
                    backgroundColor: [
                        '#dc2626',
                        '#f97316', 
                        '#fbbf24',
                        '#22c55e',
                        '#16a34a'
                    ],
                    borderRadius: 6,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return `${context[0].dataIndex + 1} Star Reviews`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            color: '#9ca3af'
                        },
                        grid: {
                            color: 'rgba(156, 163, 175, 0.2)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Enhanced Trends Chart
    const trendsCtx = document.getElementById('trendsChart');
    if (trendsCtx) {
        const trendLabels = trendsData.length ? trendsData.map(item => item.date) : generateSampleDates(7);
        const trendValues = trendsData.length ? trendsData.map(item => item.avg_score) : [4.2, 4.1, 4.3, 4.0, 4.2, 4.4, 4.3];
        
        trendsChart = new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Average Sentiment Score',
                    data: trendValues,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#1e40af',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5,
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            color: 'rgba(156, 163, 175, 0.2)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
}

// Interactive Chart Functions
function toggleSentimentView(view) {
    currentSentimentView = view;
    
    // Update button states
    document.querySelectorAll('[onclick*="toggleSentimentView"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update chart based on view
    if (view === 'emotion') {
        updateSentimentChart('emotion');
    } else if (view === 'timeline') {
        updateSentimentChart('timeline');
    } else {
        updateSentimentChart('intensity');
    }
}

function toggleTopicView(view) {
    currentTopicView = view;
    
    // Update button states
    document.querySelectorAll('[onclick*="toggleTopicView"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const keywordAnalysis = document.getElementById('keywordAnalysis');
    
    if (view === 'keywords') {
        // Show keywords and topic metrics (default view)
        keywordAnalysis.innerHTML = generateKeywordsView();
    } else if (view === 'topics') {
        // Show emerging topics
        keywordAnalysis.innerHTML = generateTopicsView();
    } else if (view === 'issues') {
        // Show main issues identified
        keywordAnalysis.innerHTML = generateIssuesView();
    }
}

function generateKeywordsView() {
    const aiData = window.aiTagsData || {};
    const positiveKeywords = aiData.positive_keywords || ['excellent', 'clean', 'friendly', 'comfortable', 'beautiful'];
    const negativeKeywords = aiData.negative_keywords || ['dirty', 'noise', 'rude', 'expensive', 'old'];
    const topicMetrics = aiData.topic_metrics || {};
    
    return `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-success mb-3"><i class="fas fa-thumbs-up me-2"></i>Top Positive Keywords</h6>
                <div class="keyword-cloud positive">
                    ${positiveKeywords.map((keyword, index) => {
                        const size = index < 3 ? 'large' : (index < 6 ? 'medium' : 'small');
                        return `<span class="keyword-tag ${size}">${keyword}</span>`;
                    }).join('')}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-danger mb-3"><i class="fas fa-thumbs-down me-2"></i>Top Negative Keywords</h6>
                <div class="keyword-cloud negative">
                    ${negativeKeywords.map((keyword, index) => {
                        const size = index < 3 ? 'large' : (index < 6 ? 'medium' : 'small');
                        return `<span class="keyword-tag ${size}">${keyword}</span>`;
                    }).join('')}
                </div>
            </div>
        </div>
        
        <!-- Topic Breakdown -->
        <div class="row mt-4">
            ${generateTopicCards(topicMetrics)}
        </div>
    `;
}

function generateTopicsView() {
    const aiData = window.aiTagsData || {};
    let emergingTopics = [];
    
    console.log('AI Data for topics view:', aiData);
    console.log('Emerging topics raw:', aiData.emerging_topics);
    
    // Get emerging topics from AI data
    if (aiData.emerging_topics && Array.isArray(aiData.emerging_topics) && aiData.emerging_topics.length > 0) {
        emergingTopics = aiData.emerging_topics;
        console.log('Using AI-generated emerging topics:', emergingTopics);
    } else {
        // Fallback if no AI data available
        emergingTopics = [
            'Health and safety protocols',
            'Digital service integration', 
            'Sustainability practices',
            'Contactless services',
            'Flexible booking policies'
        ];
        console.log('Using fallback emerging topics:', emergingTopics);
    }
    
    return `
        <div class="row">
            <div class="col-12">
                <h6 class="text-primary mb-4"><i class="fas fa-lightbulb me-2"></i>Emerging Topics & Trends</h6>
                <div class="row">
                    ${emergingTopics.map((topic, index) => `
                        <div class="col-md-6 mb-3">
                            <div class="emerging-topic-card">
                                <div class="topic-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="topic-content">
                                    <h6 style="color: #1f2937 !important; font-weight: 600; margin-bottom: 0.25rem;">${topic}</h6>
                                    <small style="color: #6b7280 !important;">Trend #${index + 1}</small>
                                </div>
                                <div class="topic-badge">
                                    <span class="badge bg-info">Emerging</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function generateIssuesView() {
    const aiData = window.aiTagsData || {};
    let mainIssues = [];
    
    console.log('AI Data for issues view:', aiData);
    console.log('Issues identified raw:', aiData.issues_identified);
    
    // Get issues from AI data
    if (aiData.issues_identified && Array.isArray(aiData.issues_identified) && aiData.issues_identified.length > 0) {
        mainIssues = aiData.issues_identified;
        console.log('Using AI-generated issues:', mainIssues);
    } else {
        // Fallback if no AI data available
        mainIssues = [
            'Service quality concerns',
            'Cleanliness standards',
            'Noise levels',
            'Value for money',
            'Facility maintenance'
        ];
        console.log('Using fallback issues:', mainIssues);
    }
    
    return `
        <div class="row">
            <div class="col-12">
                <h6 class="text-warning mb-4"><i class="fas fa-exclamation-triangle me-2"></i>Main Issues Identified</h6>
                <div class="issues-list">
                    ${mainIssues.map((issue, index) => `
                        <div class="issue-item">
                            <div class="issue-priority ${index < 2 ? 'high' : (index < 4 ? 'medium' : 'low')}"></div>
                            <div class="issue-content">
                                <div class="issue-title" style="color: #1f2937 !important; font-weight: 600; font-size: 1.1rem;">${issue}</div>
                                <div class="issue-desc" style="color: #6b7280 !important; font-size: 0.875rem;">Issue #${index + 1} - Requires attention</div>
                            </div>
                            <div class="issue-impact">
                                <span class="badge ${index < 2 ? 'bg-danger' : (index < 4 ? 'bg-warning text-dark' : 'bg-info')}">
                                    ${index < 2 ? 'High Priority' : (index < 4 ? 'Medium Priority' : 'Low Priority')}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function generateTopicCards(topicMetrics) {
    const topics = [
        { key: 'service', icon: 'fas fa-concierge-bell', title: 'Service' },
        { key: 'cleanliness', icon: 'fas fa-broom', title: 'Cleanliness' },
        { key: 'location', icon: 'fas fa-map-marker-alt', title: 'Location' },
        { key: 'value', icon: 'fas fa-dollar-sign', title: 'Value' }
    ];
    
    return topics.map(topic => {
        const data = topicMetrics[topic.key] || { percentage: 75, keywords: ['analysis', 'pending'], description: 'Analysis pending' };
        const scoreClass = data.percentage >= 70 ? 'positive' : 'negative';
        
        return `
            <div class="col-md-3">
                <div class="topic-card ${topic.key}">
                    <div class="topic-icon">
                        <i class="${topic.icon}"></i>
                    </div>
                    <h6>${topic.title}</h6>
                    <div class="topic-score ${scoreClass}">${data.percentage}%</div>
                    <small class="text-muted">${data.keywords ? data.keywords.join(', ') : 'Loading...'}</small>
                </div>
            </div>
        `;
    }).join('');
}

function toggleTrendView(view) {
    currentTrendView = view;
    
    // Update button states
    document.querySelectorAll('[onclick*="toggleTrendView"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update trends chart
    if (view === 'volume') {
        updateTrendsChart('volume');
    } else {
        updateTrendsChart('sentiment');
    }
}

function updateSentimentChart(type) {
    if (!sentimentChart) return;
    
    if (type === 'emotion') {
        sentimentChart.data.labels = ['Joy', 'Satisfaction', 'Neutral', 'Frustration', 'Anger'];
        sentimentChart.data.datasets[0].data = [35, 40, 15, 7, 3];
        sentimentChart.data.datasets[0].backgroundColor = ['#22c55e', '#16a34a', '#fbbf24', '#f97316', '#dc2626'];
    } else if (type === 'timeline') {
        // Convert to line chart for timeline view
        // This would require recreating the chart
        console.log('Timeline view would show sentiment over time');
    } else {
        // Reset to intensity view
        sentimentChart.data.labels = ['Very Positive', 'Positive', 'Neutral', 'Negative', 'Very Negative'];
        sentimentChart.data.datasets[0].data = [
            Math.round((sentimentData.positive || 0) * 0.45),
            Math.round((sentimentData.positive || 0) * 0.55),
            sentimentData.neutral || 0,
            Math.round((sentimentData.negative || 0) * 0.6),
            Math.round((sentimentData.negative || 0) * 0.4)
        ];
    }
    
    sentimentChart.update();
}

function updateTrendsChart(type) {
    if (!trendsChart) return;
    
    if (type === 'volume') {
        trendsChart.data.datasets[0].label = 'Review Volume';
        trendsChart.data.datasets[0].data = [12, 18, 15, 22, 19, 25, 20];
        trendsChart.options.scales.y.max = 30;
    } else {
        trendsChart.data.datasets[0].label = 'Average Sentiment Score';
        trendsChart.data.datasets[0].data = [4.2, 4.1, 4.3, 4.0, 4.2, 4.4, 4.3];
        trendsChart.options.scales.y.max = 5;
    }
    
    trendsChart.update();
}

// Filter Functions
function initializeFilters() {
    const dateRangeSelect = document.getElementById('dateRangeSelect');
    const sentimentFilter = document.getElementById('sentimentFilter');
    const keywordFilter = document.getElementById('keywordFilter');
    
    if (sentimentFilter) {
        sentimentFilter.addEventListener('change', applyFilters);
    }
    
    if (keywordFilter) {
        keywordFilter.addEventListener('input', debounce(applyFilters, 500));
    }
}

function applyFilters() {
    const sentimentFilter = document.getElementById('sentimentFilter').value;
    const keywordFilter = document.getElementById('keywordFilter').value.toLowerCase();
    
    console.log('Applying filters:', { sentiment: sentimentFilter, keyword: keywordFilter });
    
    // Here you would typically make an AJAX call to filter the data
    // For now, we'll just show a loading state
    showFilteringState();
    
    // Simulate API call
    setTimeout(() => {
        hideFilteringState();
        // Update charts with filtered data
        refreshChartsWithFilters(sentimentFilter, keywordFilter);
    }, 1000);
}

function refreshChartsWithFilters(sentiment, keyword) {
    // Implementation would update all charts based on filters
    console.log('Refreshing charts with filters:', sentiment, keyword);
}

function showFilteringState() {
    // Add loading indicators to charts
    document.querySelectorAll('.card-body canvas').forEach(canvas => {
        canvas.style.opacity = '0.5';
    });
}

function hideFilteringState() {
    document.querySelectorAll('.card-body canvas').forEach(canvas => {
        canvas.style.opacity = '1';
    });
}

// Keyword Interactions
function initializeKeywordInteractions() {
    document.querySelectorAll('.keyword-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const keyword = this.textContent.trim();
            document.getElementById('keywordFilter').value = keyword;
            applyFilters();
        });
    });
}

// Insight Interactions
function initializeInsightInteractions() {
    document.querySelectorAll('.insight-item').forEach(item => {
        item.addEventListener('click', function() {
            // Show detailed insight modal or expand details
            const title = this.querySelector('.insight-title').textContent;
            showInsightDetails(title);
        });
    });
}

function showInsightDetails(title) {
    // Implementation would show a modal with detailed insight information
    console.log('Showing details for insight:', title);
}

// Utility Functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function generateSampleDates(days) {
    const dates = [];
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    }
    return dates;
}

function changeTimeRange() {
    const range = document.getElementById('dateRangeSelect').value;
    console.log('Changing time range to:', range, 'days');
    
    // Show loading state
    showFilteringState();
    
    // Simulate API call to get new data
    setTimeout(() => {
        hideFilteringState();
        // Refresh all data
        location.reload();
    }, 1500);
}

function refreshData() {
    console.log('Refreshing analytics data...');
    showFilteringState();
    
    setTimeout(() => {
        hideFilteringState();
        location.reload();
    }, 1000);
}

// Export functionality
function performExport() {
    const format = document.getElementById('exportFormat').value;
    const dateRange = document.getElementById('exportDateRange').value;
    const includeCharts = document.getElementById('includeCharts').checked;
    const includeRawData = document.getElementById('includeRawData').checked;
    
    console.log('Exporting data:', { format, dateRange, includeCharts, includeRawData });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    modal.hide();
    
    // Show success message
    alert(`Export started! Your ${format.toUpperCase()} file will be downloaded shortly.`);
}
</script>
{% endblock %}
