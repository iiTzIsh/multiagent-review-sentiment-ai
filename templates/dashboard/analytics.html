{% extends 'base/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Hotel Review Analytics{% endblock %}

{% block page_icon %}<i class="fas fa-chart-bar me-2"></i>{% endblock %}
{% block page_title %}Analytics Dashboard{% endblock %}

{% block page_description %}
<p class="page-description">Comprehensive review analytics and insights</p>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2 flex-wrap">
    <a href="{% url 'dashboard:upload_reviews' %}" class="btn btn-primary" data-bs-toggle="tooltip" title="Upload new review data">
        <i class="fas fa-upload me-1"></i>Upload Reviews
    </a>
    <button id="process-reviews-btn" class="btn btn-success" data-bs-toggle="tooltip" title="Process uploaded reviews with AI">
        <i class="fas fa-cog me-1"></i>Process Reviews
    </button>
    <button class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Refresh analytics data">
        <i class="fas fa-sync-alt me-1"></i>Refresh
    </button>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
<style>
    /* Modern Card Header Styles for Analytics Page */
    .card .card-header {
        background: #1e3a8a !important;
        border: none !important;
        color: white !important;
        padding: 1rem 1.25rem !important;
        border-radius: 12px 12px 0 0 !important;
    }

    /* Alternate header colors in professional blues and teals */
    .card:nth-child(3n+1) .card-header {
        background: #1e3a8a !important; /* Professional dark blue */
    }

    .card:nth-child(3n+2) .card-header {
        background: #0f766e !important; /* Teal green */
    }

    .card:nth-child(3n+3) .card-header {
        background: #1e40af !important; /* Royal blue */
    }

    /* Additional professional variations */
    .card:nth-child(6n+4) .card-header {
        background: #0369a1 !important; /* Sky blue */
    }

    .card:nth-child(6n+5) .card-header {
        background: #115e59 !important; /* Dark teal */
    }

    .card:nth-child(6n+6) .card-header {
        background: #1d4ed8 !important; /* Bright blue */
    }

    /* Ensure header text and elements are always white and visible */
    .card .card-header *,
    .card .card-header h1,
    .card .card-header h2,
    .card .card-header h3,
    .card .card-header h4,
    .card .card-header h5,
    .card .card-header h6,
    .card .card-header .card-title,
    .card .card-header span,
    .card .card-header p,
    .card .card-header i,
    .card .card-header .fas,
    .card .card-header .far,
    .card .card-header .fab {
        color: white !important;
    }

    .card .card-header .btn-outline-secondary {
        border-color: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
    }

    .card .card-header .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
    }

    .card .card-header .btn-outline-light {
        border-color: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
    }

    .card .card-header .btn-outline-light:hover,
    .card .card-header .btn-outline-light.active {
        background-color: rgba(255, 255, 255, 0.2) !important;
        border-color: rgba(255, 255, 255, 0.8) !important;
        color: white !important;
    }

    /* Make sure card bodies still have proper dark theme styling */
    .card .card-body {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }

    /* Enhanced Sentiment Analysis Styles */
    .sentiment-score {
        padding: 1rem;
    }

    .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        border: 3px solid;
    }

    .score-circle .score-number {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .sentiment-score.positive .score-circle {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }

    .sentiment-score.neutral .score-circle {
        border-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    .sentiment-score.negative .score-circle {
        border-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    /* Keyword Cloud Styles */
    .keyword-cloud {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .keyword-cloud.positive {
        background: rgba(40, 167, 69, 0.1);
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .keyword-cloud.negative {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .keyword-tag {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        margin: 0.25rem;
        border-radius: 20px;
        font-weight: 500;
        transition: transform 0.2s ease;
        cursor: pointer;
    }

    .keyword-tag:hover {
        transform: scale(1.05);
    }

    .keyword-cloud.positive .keyword-tag {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .keyword-cloud.negative .keyword-tag {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .keyword-tag.large {
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
    }

    .keyword-tag.medium {
        font-size: 1rem;
        padding: 0.375rem 0.875rem;
    }

    .keyword-tag.small {
        font-size: 0.875rem;
        padding: 0.25rem 0.625rem;
    }

    /* Topic Cards */
    .topic-card {
        text-align: center;
        padding: 1.5rem 1rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .topic-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .topic-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .topic-icon i {
        font-size: 1.5rem;
    }

    .topic-score {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0.5rem 0;
    }

    .topic-score.positive {
        color: #28a745;
    }

    .topic-score.negative {
        color: #dc3545;
    }

    /* Actionable Insights Styles */
    .insights-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .insight-item {
        display: flex;
        align-items: flex-start;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-left: 4px solid;
        transition: transform 0.2s ease;
    }

    .insight-item:hover {
        transform: translateX(2px);
    }

    .insight-item.urgent {
        border-left-color: #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .insight-item.important {
        border-left-color: #ffc107;
        background: rgba(255, 193, 7, 0.1);
    }

    .insight-item.moderate {
        border-left-color: #17a2b8;
        background: rgba(23, 162, 184, 0.1);
    }

    .insight-item.success {
        border-left-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }

    .insight-priority {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 1rem;
        margin-top: 0.5rem;
        flex-shrink: 0;
    }

    .insight-priority.high {
        background: #dc3545;
    }

    .insight-priority.medium {
        background: #ffc107;
    }

    .insight-priority.low {
        background: #17a2b8;
    }

    .insight-priority.success {
        background: #28a745;
    }

    .insight-content {
        flex-grow: 1;
    }

    .insight-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .insight-desc {
        color: var(--text-muted);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .insight-action {
        color: var(--text-muted);
        font-size: 0.8rem;
    }

    .insight-impact {
        margin-left: 1rem;
        align-self: flex-start;
    }

    /* Enhanced Metric Cards */
    .metric-card {
        border-radius: 12px;
        padding: 1.5rem;
        border: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 140px; /* Fixed height for all cards */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.875rem;
        opacity: 0.9;
        font-weight: 500;
    }

    /* Stars Rating */
    .stars i {
        font-size: 0.75rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .keyword-cloud {
            text-align: center;
        }
        
        .topic-card {
            margin-bottom: 1rem;
        }
        
        .insight-item {
            flex-direction: column;
            text-align: center;
        }
        
        .insight-priority {
            margin: 0 auto 0.5rem;
        }
        
        .insight-impact {
            margin: 0.5rem 0 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Add spacing between header and cards -->
            <div class="mb-5"></div>
            
            <!-- Enhanced Executive Summary Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-primary text-white fade-in">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ statistics.total_reviews|default:0 }}</div>
                                <div class="metric-label">Total Reviews</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-comments fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                <i class="fas fa-arrow-up me-1"></i>+12% from last month
                            </small>
                            <small class="opacity-75">
                                {{ date_range.start|date:"M j" }} - {{ date_range.end|date:"M j" }}
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-success text-white fade-in" style="animation-delay: 0.1s">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ statistics.average_score|default:0|floatformat:1 }}/5</div>
                                <div class="metric-label">Average Satisfaction</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-star fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                {% if statistics.average_score >= 4 %}
                                <i class="fas fa-arrow-up me-1"></i>Excellent Rating
                                {% elif statistics.average_score >= 3 %}
                                <i class="fas fa-minus me-1"></i>Good Rating
                                {% else %}
                                <i class="fas fa-arrow-down me-1"></i>Needs Improvement
                                {% endif %}
                            </small>
                            <small class="opacity-75">
                                {{ statistics.processing_rate|floatformat:1 }}% Processed
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-info text-white fade-in" style="animation-delay: 0.2s">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ statistics.positive_percentage|default:0|floatformat:0 }}%</div>
                                <div class="metric-label">Positive Sentiment</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-smile fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                <i class="fas fa-chart-line me-1"></i>+5% vs last period
                            </small>
                            <small class="opacity-75">
                                {{ statistics.negative_percentage|default:0|floatformat:0 }}% Negative
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="metric-card bg-warning text-white fade-in" style="animation-delay: 0.3s">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="metric-value">{{ top_hotels|length|default:0 }}</div>
                                <div class="metric-label">Active Hotels</div>
                            </div>
                            <div class="opacity-75">
                                <i class="fas fa-hotel fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <small class="opacity-90">
                                <i class="fas fa-clock me-1"></i>Real-time monitoring
                            </small>
                         
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Analytics Charts Row -->
            <div class="row mb-4">

            </div>

            <!-- Topic Analysis Row -->
            <div class="row mb-4">
                <!-- Topic & Theme Analysis -->
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-tags me-2"></i>Topic & Theme Analysis
                                </h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-light active" onclick="toggleTopicView('keywords')">
                                        Keywords
                                    </button>
                                    <button class="btn btn-outline-light" onclick="toggleTopicView('topics')">
                                        Topics
                                    </button>
                                    <button class="btn btn-outline-light" onclick="toggleTopicView('issues')">
                                        Issues
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Keyword Frequency Analysis -->
                            <div id="keywordAnalysis">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-success mb-3"><i class="fas fa-thumbs-up me-2"></i>Top Positive Keywords</h6>
                                        <div class="keyword-cloud positive">
                                            <span class="keyword-tag large">excellent</span>
                                            <span class="keyword-tag medium">clean</span>
                                            <span class="keyword-tag large">friendly</span>
                                            <span class="keyword-tag small">comfortable</span>
                                            <span class="keyword-tag medium">beautiful</span>
                                            <span class="keyword-tag large">perfect</span>
                                            <span class="keyword-tag small">amazing</span>
                                            <span class="keyword-tag medium">helpful</span>
                                            <span class="keyword-tag small">spacious</span>
                                            <span class="keyword-tag medium">convenient</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-danger mb-3"><i class="fas fa-thumbs-down me-2"></i>Top Negative Keywords</h6>
                                        <div class="keyword-cloud negative">
                                            <span class="keyword-tag large">dirty</span>
                                            <span class="keyword-tag medium">noise</span>
                                            <span class="keyword-tag large">rude</span>
                                            <span class="keyword-tag small">expensive</span>
                                            <span class="keyword-tag medium">old</span>
                                            <span class="keyword-tag large">broken</span>
                                            <span class="keyword-tag small">slow</span>
                                            <span class="keyword-tag medium">uncomfortable</span>
                                            <span class="keyword-tag small">smelly</span>
                                            <span class="keyword-tag medium">disappointing</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Topic Breakdown -->
                                <div class="row mt-4">
                                    <div class="col-md-3">
                                        <div class="topic-card service">
                                            <div class="topic-icon">
                                                <i class="fas fa-concierge-bell"></i>
                                            </div>
                                            <h6>Service</h6>
                                            <div class="topic-score positive">85%</div>
                                            <small class="text-muted">Staff, Support, Help</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="topic-card cleanliness">
                                            <div class="topic-icon">
                                                <i class="fas fa-broom"></i>
                                            </div>
                                            <h6>Cleanliness</h6>
                                            <div class="topic-score positive">78%</div>
                                            <small class="text-muted">Clean, Hygiene, Tidy</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="topic-card location">
                                            <div class="topic-icon">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </div>
                                            <h6>Location</h6>
                                            <div class="topic-score positive">92%</div>
                                            <small class="text-muted">Area, Transport, Access</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="topic-card value">
                                            <div class="topic-icon">
                                                <i class="fas fa-dollar-sign"></i>
                                            </div>
                                            <h6>Value</h6>
                                            <div class="topic-score negative">62%</div>
                                            <small class="text-muted">Price, Cost, Worth</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actionable Insights & Hotel Performance -->
            <div class="row mb-4">
                <!-- Actionable Insights Dashboard -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Actionable Insights & Recommendations
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Priority Issues -->
                                <div class="col-md-6">
                                    <h6 class="text-danger mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Priority Issues
                                    </h6>
                                    <div class="insights-list">
                                        <div class="insight-item urgent">
                                            <div class="insight-priority high"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Slow WiFi Complaints</div>
                                                <div class="insight-desc">15 mentions in last 7 days</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Contact IT support immediately</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-danger">High Impact</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item important">
                                            <div class="insight-priority medium"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Housekeeping Issues</div>
                                                <div class="insight-desc">8 cleanliness complaints</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Review cleaning protocols</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-warning">Medium Impact</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item moderate">
                                            <div class="insight-priority low"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Breakfast Variety</div>
                                                <div class="insight-desc">3 suggestions for more options</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Consider menu expansion</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-info">Low Impact</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Success Stories -->
                                <div class="col-md-6">
                                    <h6 class="text-success mb-3">
                                        <i class="fas fa-trophy me-2"></i>Success Stories
                                    </h6>
                                    <div class="insights-list">
                                        <div class="insight-item success">
                                            <div class="insight-priority success"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Exceptional Front Desk</div>
                                                <div class="insight-desc">25 positive mentions this week</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Recognize and replicate practices</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-success">Keep It Up!</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item success">
                                            <div class="insight-priority success"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Perfect Location</div>
                                                <div class="insight-desc">92% positive location feedback</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Highlight in marketing</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-success">Marketing Asset</span>
                                            </div>
                                        </div>
                                        
                                        <div class="insight-item success">
                                            <div class="insight-priority success"></div>
                                            <div class="insight-content">
                                                <div class="insight-title">Room Comfort</div>
                                                <div class="insight-desc">Consistent 4.5+ star ratings</div>
                                                <div class="insight-action">
                                                    <small><i class="fas fa-arrow-right me-1"></i>Use as selling point</small>
                                                </div>
                                            </div>
                                            <div class="insight-impact">
                                                <span class="badge bg-success">Competitive Edge</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Hotels Performance -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-trophy me-2"></i>Hotel Performance
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for hotel in top_hotels %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ hotel.name|truncatechars:25 }}</h6>
                                            <small class="text-muted">
                                                <i class="fas fa-map-marker-alt"></i> {{ hotel.city|default:"Location N/A" }}
                                            </small>
                                            <div class="mt-1">
                                                <div class="d-flex align-items-center">
                                                    <div class="stars me-2">
                                                        {% for i in "12345" %}
                                                            <i class="fas fa-star {% if forloop.counter <= hotel.avg_rating %}text-warning{% else %}text-muted{% endif %}"></i>
                                                        {% endfor %}
                                                    </div>
                                                    <small class="text-muted">{{ hotel.avg_rating|floatformat:1 }}/5</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-primary rounded-pill mb-1">
                                                {{ hotel.review_count }} reviews
                                            </span>
                                            {% if hotel.sentiment_trend > 0 %}
                                                <br><small class="text-success"><i class="fas fa-arrow-up"></i> +{{ hotel.sentiment_trend }}%</small>
                                            {% elif hotel.sentiment_trend < 0 %}
                                                <br><small class="text-danger"><i class="fas fa-arrow-down"></i> {{ hotel.sentiment_trend }}%</small>
                                            {% else %}
                                                <br><small class="text-muted"><i class="fas fa-minus"></i> No change</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center text-muted py-4">
                                    <i class="fas fa-hotel fa-2x mb-2"></i>
                                    <p class="mb-0">No hotel data available</p>
                                    <small>Upload reviews to see performance data</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Analytics Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="csv">CSV (Comma Separated)</option>
                            <option value="excel">Excel Spreadsheet</option>
                            <option value="json">JSON Data</option>
                            <option value="pdf">PDF Report</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportDateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="exportDateRange">
                            <option value="current">Current Period ({{ date_range.days }} days)</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 3 Months</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">
                                Include Charts and Visualizations
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeRawData">
                            <label class="form-check-label" for="includeRawData">
                                Include Raw Review Data
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performExport()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart data as JSON -->
{{ sentiment_chart|json_script:"sentiment-data" }}
{{ score_distribution|json_script:"score-data" }}
{{ daily_trends|json_script:"trends-data" }}
{{ hotel_performance|json_script:"hotel-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let sentimentChart, scoreChart, trendsChart;
let currentSentimentView = 'intensity';
let currentTopicView = 'keywords';
let currentTrendView = 'sentiment';

// Get chart data from JSON scripts
function getSafeJsonData(elementId) {
    const element = document.getElementById(elementId);
    if (element && element.textContent) {
        try {
            return JSON.parse(element.textContent);
        } catch (e) {
            console.warn('Failed to parse JSON data for', elementId);
            return null;
        }
    }
    return null;
}

const sentimentData = getSafeJsonData('sentiment-data') || { positive: 0, negative: 0, neutral: 0 };
const scoreData = getSafeJsonData('score-data') || [];
const trendsData = getSafeJsonData('trends-data') || [];
const hotelData = getSafeJsonData('hotel-data') || [];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedAnalyticsCharts();
    initializeFilters();
    initializeKeywordInteractions();
    initializeInsightInteractions();
});

function initializeEnhancedAnalyticsCharts() {
    // Enhanced Sentiment Distribution Chart
    const sentimentCtx = document.getElementById('sentimentChart');
    if (sentimentCtx) {
        sentimentChart = new Chart(sentimentCtx, {
            type: 'doughnut',
            data: {
                labels: ['Very Positive', 'Positive', 'Neutral', 'Negative', 'Very Negative'],
                datasets: [{
                    data: [
                        Math.round((sentimentData.positive || 0) * 0.45),
                        Math.round((sentimentData.positive || 0) * 0.55),
                        sentimentData.neutral || 0,
                        Math.round((sentimentData.negative || 0) * 0.6),
                        Math.round((sentimentData.negative || 0) * 0.4)
                    ],
                    backgroundColor: [
                        '#22c55e',
                        '#16a34a', 
                        '#fbbf24',
                        '#f87171',
                        '#dc2626'
                    ],
                    borderWidth: 2,
                    borderColor: '#1f2937'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            color: '#e5e7eb',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} reviews (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Enhanced Score Distribution Chart
    const scoreCtx = document.getElementById('scoreChart');
    if (scoreCtx) {
        const scoreLabels = ['⭐', '⭐⭐', '⭐⭐⭐', '⭐⭐⭐⭐', '⭐⭐⭐⭐⭐'];
        const scoreValues = scoreData.length ? scoreData.map(item => item.count || 0) : [3, 7, 15, 30, 45];
        
        scoreChart = new Chart(scoreCtx, {
            type: 'bar',
            data: {
                labels: scoreLabels,
                datasets: [{
                    label: 'Number of Reviews',
                    data: scoreValues,
                    backgroundColor: [
                        '#dc2626',
                        '#f97316', 
                        '#fbbf24',
                        '#22c55e',
                        '#16a34a'
                    ],
                    borderRadius: 6,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return `${context[0].dataIndex + 1} Star Reviews`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            color: '#9ca3af'
                        },
                        grid: {
                            color: 'rgba(156, 163, 175, 0.2)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Enhanced Trends Chart
    const trendsCtx = document.getElementById('trendsChart');
    if (trendsCtx) {
        const trendLabels = trendsData.length ? trendsData.map(item => item.date) : generateSampleDates(7);
        const trendValues = trendsData.length ? trendsData.map(item => item.avg_score) : [4.2, 4.1, 4.3, 4.0, 4.2, 4.4, 4.3];
        
        trendsChart = new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Average Sentiment Score',
                    data: trendValues,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#1e40af',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5,
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            color: 'rgba(156, 163, 175, 0.2)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
}

// Interactive Chart Functions
function toggleSentimentView(view) {
    currentSentimentView = view;
    
    // Update button states
    document.querySelectorAll('[onclick*="toggleSentimentView"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update chart based on view
    if (view === 'emotion') {
        updateSentimentChart('emotion');
    } else if (view === 'timeline') {
        updateSentimentChart('timeline');
    } else {
        updateSentimentChart('intensity');
    }
}

function toggleTopicView(view) {
    currentTopicView = view;
    
    // Update button states
    document.querySelectorAll('[onclick*="toggleTopicView"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide relevant sections
    // Implementation would switch between keyword cloud, topic breakdown, and issues list
    console.log('Switching to topic view:', view);
}

function toggleTrendView(view) {
    currentTrendView = view;
    
    // Update button states
    document.querySelectorAll('[onclick*="toggleTrendView"]').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update trends chart
    if (view === 'volume') {
        updateTrendsChart('volume');
    } else {
        updateTrendsChart('sentiment');
    }
}

function updateSentimentChart(type) {
    if (!sentimentChart) return;
    
    if (type === 'emotion') {
        sentimentChart.data.labels = ['Joy', 'Satisfaction', 'Neutral', 'Frustration', 'Anger'];
        sentimentChart.data.datasets[0].data = [35, 40, 15, 7, 3];
        sentimentChart.data.datasets[0].backgroundColor = ['#22c55e', '#16a34a', '#fbbf24', '#f97316', '#dc2626'];
    } else if (type === 'timeline') {
        // Convert to line chart for timeline view
        // This would require recreating the chart
        console.log('Timeline view would show sentiment over time');
    } else {
        // Reset to intensity view
        sentimentChart.data.labels = ['Very Positive', 'Positive', 'Neutral', 'Negative', 'Very Negative'];
        sentimentChart.data.datasets[0].data = [
            Math.round((sentimentData.positive || 0) * 0.45),
            Math.round((sentimentData.positive || 0) * 0.55),
            sentimentData.neutral || 0,
            Math.round((sentimentData.negative || 0) * 0.6),
            Math.round((sentimentData.negative || 0) * 0.4)
        ];
    }
    
    sentimentChart.update();
}

function updateTrendsChart(type) {
    if (!trendsChart) return;
    
    if (type === 'volume') {
        trendsChart.data.datasets[0].label = 'Review Volume';
        trendsChart.data.datasets[0].data = [12, 18, 15, 22, 19, 25, 20];
        trendsChart.options.scales.y.max = 30;
    } else {
        trendsChart.data.datasets[0].label = 'Average Sentiment Score';
        trendsChart.data.datasets[0].data = [4.2, 4.1, 4.3, 4.0, 4.2, 4.4, 4.3];
        trendsChart.options.scales.y.max = 5;
    }
    
    trendsChart.update();
}

// Filter Functions
function initializeFilters() {
    const dateRangeSelect = document.getElementById('dateRangeSelect');
    const sentimentFilter = document.getElementById('sentimentFilter');
    const keywordFilter = document.getElementById('keywordFilter');
    
    if (sentimentFilter) {
        sentimentFilter.addEventListener('change', applyFilters);
    }
    
    if (keywordFilter) {
        keywordFilter.addEventListener('input', debounce(applyFilters, 500));
    }
}

function applyFilters() {
    const sentimentFilter = document.getElementById('sentimentFilter').value;
    const keywordFilter = document.getElementById('keywordFilter').value.toLowerCase();
    
    console.log('Applying filters:', { sentiment: sentimentFilter, keyword: keywordFilter });
    
    // Here you would typically make an AJAX call to filter the data
    // For now, we'll just show a loading state
    showFilteringState();
    
    // Simulate API call
    setTimeout(() => {
        hideFilteringState();
        // Update charts with filtered data
        refreshChartsWithFilters(sentimentFilter, keywordFilter);
    }, 1000);
}

function refreshChartsWithFilters(sentiment, keyword) {
    // Implementation would update all charts based on filters
    console.log('Refreshing charts with filters:', sentiment, keyword);
}

function showFilteringState() {
    // Add loading indicators to charts
    document.querySelectorAll('.card-body canvas').forEach(canvas => {
        canvas.style.opacity = '0.5';
    });
}

function hideFilteringState() {
    document.querySelectorAll('.card-body canvas').forEach(canvas => {
        canvas.style.opacity = '1';
    });
}

// Keyword Interactions
function initializeKeywordInteractions() {
    document.querySelectorAll('.keyword-tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const keyword = this.textContent.trim();
            document.getElementById('keywordFilter').value = keyword;
            applyFilters();
        });
    });
}

// Insight Interactions
function initializeInsightInteractions() {
    document.querySelectorAll('.insight-item').forEach(item => {
        item.addEventListener('click', function() {
            // Show detailed insight modal or expand details
            const title = this.querySelector('.insight-title').textContent;
            showInsightDetails(title);
        });
    });
}

function showInsightDetails(title) {
    // Implementation would show a modal with detailed insight information
    console.log('Showing details for insight:', title);
}

// Utility Functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function generateSampleDates(days) {
    const dates = [];
    for (let i = days - 1; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    }
    return dates;
}

function changeTimeRange() {
    const range = document.getElementById('dateRangeSelect').value;
    console.log('Changing time range to:', range, 'days');
    
    // Show loading state
    showFilteringState();
    
    // Simulate API call to get new data
    setTimeout(() => {
        hideFilteringState();
        // Refresh all data
        location.reload();
    }, 1500);
}

function refreshData() {
    console.log('Refreshing analytics data...');
    showFilteringState();
    
    setTimeout(() => {
        hideFilteringState();
        location.reload();
    }, 1000);
}

// Export functionality
function performExport() {
    const format = document.getElementById('exportFormat').value;
    const dateRange = document.getElementById('exportDateRange').value;
    const includeCharts = document.getElementById('includeCharts').checked;
    const includeRawData = document.getElementById('includeRawData').checked;
    
    console.log('Exporting data:', { format, dateRange, includeCharts, includeRawData });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportModal'));
    modal.hide();
    
    // Show success message
    alert(`Export started! Your ${format.toUpperCase()} file will be downloaded shortly.`);
}
</script>
{% endblock %}
