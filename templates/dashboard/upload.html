{% extends 'base/base.html' %}
{% load static %}

{% block title %}Upload Reviews - Hotel Review Insight Platform{% endblock %}

{% block page_icon %}<i class="fas fa-upload"></i>{% endblock %}
{% block page_title %}Upload Reviews{% endblock %}

{% block page_description %}
<p class="page-description">Upload CSV or Excel files containing hotel review data for AI analysis</p>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#templateModal">
        <i class="fas fa-download me-1"></i>Download Template
    </button>
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="tooltip" title="View upload history">
        <i class="fas fa-history me-1"></i>History
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .upload-messages {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1055;
        max-width: 400px;
    }
    
    .upload-status {
        margin-top: 1rem;
        padding: 1rem 1.25rem;
        border-radius: var(--border-radius);
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        font-weight: 500;
        border-left: 4px solid;
    }
    
    .upload-status.success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-left-color: #22c55e;
        color: #ffffff;
    }
    
    .upload-status.error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-left-color: #ef4444;
        color: #ffffff;
    }
    
    .upload-status.info {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-left-color: #3b82f6;
        color: #ffffff;
    }
    
    .upload-status i {
        font-size: 1.1em;
    }
    
    .upload-status .btn {
        font-size: 0.875rem;
        padding: 0.25rem 0.75rem;
    }
    
    /* Animation improvements */
    .progress-bar {
        transition: width 0.3s ease, background-color 0.3s ease;
    }
    
    .upload-zone {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px dashed #6b7280;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-muted);
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .upload-zone:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }

    .upload-zone.dragover {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.15);
        transform: scale(1.02);
    }

    .upload-zone.file-selected {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
        border-style: solid;
    }

    .upload-zone.upload-success {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.15);
        border-style: solid;
    }

    .upload-zone h4 {
        color: var(--text-primary);
        margin-bottom: 1rem;
    }

    .upload-zone i {
        color: var(--text-muted);
    }

    .upload-zone.file-selected i,
    .upload-zone.upload-success i {
        color: #22c55e;
    }

    /* Upload success styling */
    .upload-status.success {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-left-color: #22c55e;
        color: #ffffff;
        border-radius: 8px;
        padding: 1.5rem;
    }

    .upload-status.success .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .upload-status.success .btn-success {
        background-color: #22c55e;
        border-color: #22c55e;
    }

    .upload-status.success .btn-success:hover {
        background-color: #16a34a;
        border-color: #16a34a;
    }

    .upload-status.success .btn-primary {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    .upload-status.success .btn-primary:hover {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    .upload-status.success .btn-outline-light {
        color: #ffffff;
        border-color: rgba(255, 255, 255, 0.5);
    }

    .upload-status.success .btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.8);
        color: #ffffff;
    }

    /* UPLOAD PAGE TEXT VISIBILITY OVERRIDES */
    /* Ensure all upload page content is clearly visible */
    .card {
        background: var(--bg-primary);
        color: var(--text-primary);
    }
    
    .card * {
        color: var(--text-primary) !important;
    }
    
    .card .text-muted {
        color: var(--text-muted) !important;
    }
    
    .card h1, .card h2, .card h3, .card h4, .card h5, .card h6 {
        color: var(--text-primary) !important;
    }
    
    .card-title {
        color: var(--text-primary) !important;
    }
    
    .card-body {
        color: var(--text-primary) !important;
    }
    
    .card-body * {
        color: var(--text-primary) !important;
    }
    
    .card-body .text-muted {
        color: var(--text-muted) !important;
    }
    
    .card-body code {
        background-color: rgba(255, 255, 255, 0.1);
        color: #ff6b6b;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
    }
    
    .card-body ul li {
        color: var(--text-primary) !important;
    }
    
    .card-body .alert {
        background-color: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        color: var(--text-primary) !important;
    }
    
    .card-body .alert * {
        color: var(--text-primary) !important;
    }
    
    /* Upload zone text */
    .upload-zone {
        color: var(--text-muted);
    }
    
    .upload-zone strong {
        color: var(--text-primary) !important;
    }
    
    /* Recent uploads section */
    .border-bottom {
        border-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    .border-bottom h6 {
        color: var(--text-primary) !important;
    }
    
    .border-bottom small {
        color: var(--text-muted) !important;
    }
    
    /* Statistics section */
    .text-center h4 {
        color: var(--text-primary) !important;
    }
    
    .text-center small {
        color: var(--text-muted) !important;
    }
    
    /* List group items */
    .list-group-item {
        background-color: var(--bg-primary);
        color: var(--text-primary) !important;
        border-color: rgba(255, 255, 255, 0.1);
    }
    
    .list-group-item span {
        color: var(--text-primary) !important;
    }
    
    /* Badge overrides */
    .badge {
        color: white !important;
    }
    
    .badge.bg-success {
        background-color: #22c55e !important;
    }
    
    .badge.bg-danger {
        background-color: #ef4444 !important;
    }
    
    .badge.bg-warning {
        background-color: #f59e0b !important;
    }
    
    .badge.bg-secondary {
        background-color: #6b7280 !important;
    }

    /* Modern Card Header Styles - Override any existing styles */
    .card .card-header {
        background: #1e3a8a !important;
        border: none !important;
        color: white !important;
        padding: 1rem 1.25rem !important;
        border-radius: 12px 12px 0 0 !important;
    }

    /* Alternate header colors in professional blues and teals */
    .card:nth-child(3n+1) .card-header {
        background: #1e3a8a !important; /* Professional dark blue */
    }

    .card:nth-child(3n+2) .card-header {
        background: #0f766e !important; /* Teal green */
    }

    .card:nth-child(3n+3) .card-header {
        background: #1e40af !important; /* Royal blue */
    }

    /* Additional professional variations */
    .card:nth-child(6n+4) .card-header {
        background: #0369a1 !important; /* Sky blue */
    }

    .card:nth-child(6n+5) .card-header {
        background: #115e59 !important; /* Dark teal */
    }

    .card:nth-child(6n+6) .card-header {
        background: #1d4ed8 !important; /* Bright blue */
    }

    /* Ensure header text and elements are always white and visible */
    .card .card-header *,
    .card .card-header h1,
    .card .card-header h2,
    .card .card-header h3,
    .card .card-header h4,
    .card .card-header h5,
    .card .card-header h6,
    .card .card-header .card-title,
    .card .card-header span,
    .card .card-header p,
    .card .card-header i,
    .card .card-header .fas,
    .card .card-header .far,
    .card .card-header .fab {
        color: white !important;
    }

    .card .card-header .btn-outline-secondary {
        border-color: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
    }

    .card .card-header .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        border-color: rgba(255, 255, 255, 0.5) !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Message Display -->
{% if messages %}
<div class="upload-messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
        {% if message.tags == 'success' %}
            <i class="fas fa-check-circle me-2"></i>
        {% elif message.tags == 'error' %}
            <i class="fas fa-exclamation-circle me-2"></i>
        {% elif message.tags == 'warning' %}
            <i class="fas fa-exclamation-triangle me-2"></i>
        {% else %}
            <i class="fas fa-info-circle me-2"></i>
        {% endif %}
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}
<div class="row g-4">
    <div class="col-lg-8">
        <!-- Upload Form -->
        <div class="card fade-in-scale">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-upload me-2 text-primary"></i>Upload Review File
                </h5>
                <p class="text-muted mb-0 mt-2 small">Select your review data file for processing</p>
            </div>
            <div class="card-body">
                <!-- Drag and Drop Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <h4>Drop your file here or click to browse</h4>
                        <p>Supported formats: CSV, Excel (.xlsx, .xls)</p>
                        <p class="small text-muted">Maximum file size: 10MB</p>
                    </div>
                    <input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
                
                <form method="post" enctype="multipart/form-data" id="uploadForm" class="mt-4" style="display: none;">
                    {% csrf_token %}
                    
                    <!-- File Info Display -->
                    <div id="fileInfo" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt me-3 fa-2x"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1" id="fileName"></h6>
                                <small class="text-muted" id="fileSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="removeFile">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Upload Options -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="processImmediately" checked>
                                <label class="form-check-label" for="processImmediately">
                                    <strong>Process immediately with AI</strong>
                                    <small class="d-block text-muted">Run sentiment analysis and classification</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="validateData" checked>
                                <label class="form-check-label" for="validateData">
                                    <strong>Validate data format</strong>
                                    <small class="d-block text-muted">Check for required columns and data integrity</small>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <i class="fas fa-upload me-1"></i>Upload & Process
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="downloadSampleFile()">
                            <i class="fas fa-download me-1"></i>Download Sample CSV
                        </button>
                    </div>
                </form>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-4" style="display: none;">
                    <div class="d-flex align-items-center mb-2">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <span>Processing file...</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- File Format Guide -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>File Format Guide
                </h5>
            </div>
            <div class="card-body">
                <h6>Required Columns:</h6>
                <ul class="list-unstyled">
                    <li><code>text</code> - The review text content</li>
                </ul>
                
                <h6 class="mt-3">Optional Columns:</h6>
                <ul class="list-unstyled">
                    <li><code>title</code> - Review title or subject</li>
                    <li><code>rating</code> - Original rating (0-5)</li>
                    <li><code>reviewer_name</code> - Name of the reviewer</li>
                    <li><code>reviewer_location</code> - Reviewer's location</li>
                    <li><code>hotel_name</code> - Name of the hotel</li>
                    <li><code>source</code> - Review platform (TripAdvisor, Booking.com, etc.)</li>
                    <li><code>date_posted</code> - Date the review was posted</li>
                </ul>
                
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Download the sample CSV file to see the correct format.
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Recent Uploads -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Recent Uploads
                </h5>
            </div>
            <div class="card-body">
                {% if recent_batches %}
                    {% for batch in recent_batches|slice:":5" %}
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ batch.file_name }}</h6>
                                <small class="text-muted">
                                    Uploaded {{ batch.upload_date|timesince }} ago
                                </small>
                            </div>
                            <span class="badge bg-{% if batch.status == 'completed' %}success{% elif batch.status == 'failed' %}danger{% elif batch.status == 'processing' %}warning{% else %}secondary{% endif %}">
                                {{ batch.status|title }}
                            </span>
                        </div>
                        
                        <div class="mt-2">
                            <div class="progress mb-2">
                                <div class="progress-bar batch-progress-bar" 
                                     data-progress="{{ batch.processing_progress|floatformat:1 }}"
                                     aria-valuenow="{{ batch.processing_progress|floatformat:0 }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">
                                {{ batch.processed_reviews }}/{{ batch.total_reviews }} processed
                                {% if batch.failed_reviews > 0 %}
                                    ({{ batch.failed_reviews }} failed)
                                {% endif %}
                            </small>
                        </div>
                        
                        <div class="mt-2">
                            <a href="{% url 'dashboard:batch_detail' batch.id %}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>View Details
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p class="mb-0">No uploads yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Upload Statistics -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Upload Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ recent_batches|length }}</h4>
                        <small class="text-muted">Total Uploads</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">
                            {% with completed_batches=recent_batches|dictsort:"status" %}
                                {{ completed_batches|length }}
                            {% endwith %}
                        </h4>
                        <small class="text-muted">Completed</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Processing Queue -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tasks me-2"></i>Processing Queue
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush" id="processingQueue">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>No active processing tasks</span>
                        <span class="badge bg-success rounded-pill">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variable to store selected file
window.selectedFile = null;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeBatchProgressBars();
    initializeUploadFunctionality();
});

function initializeBatchProgressBars() {
    // Set progress bar widths based on processing progress
    const progressBars = document.querySelectorAll('.batch-progress-bar');
    progressBars.forEach(function(bar) {
        const progress = parseFloat(bar.dataset.progress) || 0;
        bar.style.width = Math.round(progress) + '%';
        
        // Add color based on progress
        if (progress >= 100) {
            bar.classList.add('bg-success');
        } else if (progress >= 50) {
            bar.classList.add('bg-warning');
        } else {
            bar.classList.add('bg-info');
        }
    });
}

// Initialize upload functionality
function initializeUploadFunctionality() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadProgress = document.getElementById('uploadProgress');

    // Return early if essential elements don't exist
    if (!uploadZone || !fileInput) {
        return;
    }

    // Click to select file
    uploadZone.addEventListener('click', function() {
        fileInput.click();
    });

    // Drag and drop functionality
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // File input change event
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // Handle file selection
    function handleFileSelect(file) {
        // Validate file type
        const allowedTypes = ['.csv', 'text/csv', 'application/vnd.ms-excel'];
        const fileExtension = file.name.toLowerCase().split('.').pop();
        
        if (fileExtension !== 'csv' && !allowedTypes.includes(file.type)) {
            showToast('Error', 'Please select a CSV file.', 'error');
            return;
        }

        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            showToast('Error', 'File size must be less than 10MB.', 'error');
            return;
        }

        // Store file globally so we don't lose it when DOM changes
        window.selectedFile = file;
        console.log('File stored globally:', file.name, file.size);

        // Update UI elements
        if (fileName) {
            fileName.textContent = file.name;
        }
        if (fileSize) {
            fileSize.textContent = formatFileSize(file.size);
        }
        if (fileInfo) {
            fileInfo.style.display = 'block';
        }
        
        // Update upload zone text without replacing the file input
        uploadZone.classList.add('file-selected');
        const uploadContent = uploadZone.querySelector('.upload-content');
        if (uploadContent) {
            uploadContent.innerHTML = 
                '<i class="fas fa-file-csv fa-2x text-success mb-3"></i>' +
                '<strong class="text-success">File Ready:</strong><br>' + 
                '<span class="text-white">' + file.name + '</span><br>' +
                '<small class="text-muted mt-2">Click Upload & Process to continue</small>';
        }
        
        // Show the upload form
        if (uploadForm) {
            uploadForm.style.display = 'block';
        }
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
}

// File upload form handling with AJAX
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Always prevent default to handle with AJAX
            
            const fileInput = document.getElementById('fileInput');
            let file = null;
            
            // Try to get file from input or from stored selectedFile (global variable)
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                file = fileInput.files[0];
                console.log('File from input:', file.name);
            } else if (window.selectedFile) {
                file = window.selectedFile;
                console.log('File from global variable:', file.name);
            }
            
            console.log('Final file for upload:', file);
            
            if (!file) {
                showUploadStatus('error', 'Please select a file to upload.');
                return;
            }
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showUploadStatus('error', 'Please upload a CSV file only.');
                return;
            }
            
            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showUploadStatus('error', 'File size must be less than 10MB.');
                return;
            }
            
            // Show upload progress
            showUploadProgress(true);
            showUploadStatus('info', 'Uploading file... Please wait.');
            
            // Create FormData for AJAX upload with the stored file
            const formData = new FormData();
            formData.append('file', file);
            
            // Add checkbox values if elements exist
            const processImmediatelyEl = document.getElementById('processImmediately');
            const validateDataEl = document.getElementById('validateData');
            
            if (processImmediatelyEl) {
                formData.append('processImmediately', processImmediatelyEl.checked);
            }
            if (validateDataEl) {
                formData.append('validateData', validateDataEl.checked);
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // AJAX upload
            fetch(uploadForm.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showUploadProgress(false);
                
                if (data.success) {
                    // Show success message with proceed buttons
                    showUploadSuccessWithProceed(data);
                    
                    // Update upload zone to show uploaded file
                    updateUploadZoneWithSuccess(file.name, data.processed);
                    
                    // Hide the upload form
                    uploadForm.style.display = 'none';
                    
                    // Clear the stored file
                    window.selectedFile = null;
                    
                } else {
                    showUploadStatus('error', `❌ Upload failed: ${data.error}`);
                }
            })
            .catch(error => {
                showUploadProgress(false);
                showUploadStatus('error', `❌ Upload failed: Network error. Please try again.`);
                console.error('Upload error:', error);
            });
        });
    }
});

// Show/hide upload progress
function showUploadProgress(show) {
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBtn = document.getElementById('uploadBtn');
    
    if (show) {
        if (uploadProgress) {
            uploadProgress.style.display = 'block';
        }
        if (uploadBtn) {
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        }
        
        // Simulate progress animation
        let progress = 0;
        const progressBar = document.querySelector('#uploadProgress .progress-bar');
        if (progressBar) {
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 85) {
                    progress = 85;
                    clearInterval(progressInterval);
                }
                progressBar.style.width = Math.round(progress) + '%';
            }, 200);
            
            // Store interval ID for cleanup
            if (uploadBtn) {
                uploadBtn.dataset.progressInterval = progressInterval;
            }
        }
    } else {
        // Complete progress bar
        const progressBar = document.querySelector('#uploadProgress .progress-bar');
        if (progressBar) {
            progressBar.style.width = '100%';
        }
        
        // Clean up interval
        if (uploadBtn && uploadBtn.dataset.progressInterval) {
            const intervalId = uploadBtn.dataset.progressInterval;
            clearInterval(intervalId);
        }
        
        // Hide progress after animation
        setTimeout(() => {
            if (uploadProgress) {
                uploadProgress.style.display = 'none';
            }
            if (uploadBtn) {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload & Process';
            }
            if (progressBar) {
                progressBar.style.width = '0%';
            }
        }, 1000);
    }
}

// Reset upload zone
function resetUploadZone() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInfo = document.getElementById('fileInfo');
    const uploadForm = document.getElementById('uploadForm');
    
    // Clear the global file variable
    window.selectedFile = null;
    
    uploadZone.classList.remove('file-selected', 'upload-success');
    uploadZone.innerHTML = 
        '<div class="upload-content">' +
        '<i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>' +
        '<h4>Drop your file here or click to browse</h4>' +
        '<p>Supported formats: CSV, Excel (.xlsx, .xls)</p>' +
        '<p class="small text-muted">Maximum file size: 10MB</p>' +
        '</div>' +
        '<input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls" style="display: none;">';
    
    if (fileInfo) {
        fileInfo.style.display = 'none';
    }
    if (uploadForm) {
        uploadForm.style.display = 'none';
    }
    
    // Reinitialize event listeners for the new file input
    initializeUploadFunctionality();
}

// Show upload success with proceed options
function showUploadSuccessWithProceed(data) {
    // Remove existing status messages
    const existingStatus = document.querySelector('.upload-status');
    if (existingStatus) {
        existingStatus.remove();
    }
    
    // Create success message with proceed buttons
    const statusDiv = document.createElement('div');
    statusDiv.className = 'upload-status success';
    statusDiv.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <i class="fas fa-check-circle me-2"></i>
                <strong>✅ Upload Successful!</strong><br>
                <small>Processed ${data.processed} reviews successfully</small>
            </div>
            <div class="d-flex gap-2 ms-3">
                <a href="/app/batch/${data.batch_id}/" class="btn btn-sm btn-success">
                    <i class="fas fa-eye me-1"></i>View Details
                </a>
                <a href="/app/reviews/" class="btn btn-sm btn-primary">
                    <i class="fas fa-list me-1"></i>All Reviews
                </a>
                <button onclick="uploadAnother()" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-plus me-1"></i>Upload Another
                </button>
            </div>
        </div>
    `;
    
    // Insert after upload form
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.parentNode.insertBefore(statusDiv, uploadForm.nextSibling);
    
    // Show with animation
    statusDiv.style.display = 'block';
    statusDiv.style.opacity = '0';
    setTimeout(() => {
        statusDiv.style.opacity = '1';
    }, 100);
}

// Update upload zone to show successful upload
function updateUploadZoneWithSuccess(fileName, processedCount) {
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.classList.add('upload-success');
    const uploadContent = uploadZone.querySelector('.upload-content');
    if (uploadContent) {
        uploadContent.innerHTML = 
            '<i class="fas fa-check-circle fa-3x text-success mb-3"></i>' +
            '<strong class="text-success">Upload Completed!</strong><br>' +
            '<span class="text-white">' + fileName + '</span><br>' +
            '<small class="text-success mt-2">✅ ' + processedCount + ' reviews processed</small>';
    }
}

// Function to reset for another upload
function uploadAnother() {
    const uploadZone = document.getElementById('uploadZone');
    const uploadForm = document.getElementById('uploadForm');
    const fileInfo = document.getElementById('fileInfo');
    const existingStatus = document.querySelector('.upload-status');
    
    // Clear the global file variable
    window.selectedFile = null;
    
    // Reset upload zone
    uploadZone.classList.remove('file-selected', 'upload-success');
    uploadZone.innerHTML = 
        '<div class="upload-content">' +
        '<i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>' +
        '<h4>Drop your file here or click to browse</h4>' +
        '<p>Supported formats: CSV, Excel (.xlsx, .xls)</p>' +
        '<p class="small text-muted">Maximum file size: 10MB</p>' +
        '</div>' +
        '<input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls" style="display: none;">';
    
    // Reset form
    uploadForm.reset();
    uploadForm.style.display = 'none';
    if (fileInfo) {
        fileInfo.style.display = 'none';
    }
    
    // Remove status message
    if (existingStatus) {
        existingStatus.remove();
    }
    
    // Reinitialize event listeners
    initializeUploadFunctionality();
    
    // Refresh recent uploads
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Show upload status function
function showUploadStatus(type, message) {
    // Remove existing status messages
    const existingStatus = document.querySelector('.upload-status');
    if (existingStatus) {
        existingStatus.remove();
    }
    
    // Create new status message
    const statusDiv = document.createElement('div');
    statusDiv.className = `upload-status ${type}`;
    statusDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
    `;
    
    // Insert after upload form
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.parentNode.insertBefore(statusDiv, uploadForm.nextSibling);
    
    // Show with animation
    statusDiv.style.display = 'block';
    statusDiv.style.opacity = '0';
    setTimeout(() => {
        statusDiv.style.opacity = '1';
    }, 100);
    
    // Auto-hide non-error messages after 8 seconds
    if (type !== 'error') {
        setTimeout(() => {
            if (statusDiv.parentNode) {
                statusDiv.style.opacity = '0';
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 300);
            }
        }, 8000);
    }
}

// Toast notification function
function showToast(title, message, type = 'info') {
    // Create toast if not exists
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }

    const toastId = 'toast-' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle text-danger' : type === 'success' ? 'check-circle text-success' : 'info-circle text-primary'} me-2"></i>
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();

    // Remove toast element after it's hidden
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}


function downloadSampleFile() {
    const csvContent = `text,title,rating,reviewer_name,reviewer_location,hotel_name,source,date_posted
"Great hotel with excellent service and clean rooms.","Excellent Stay",5,"John Doe","New York, USA","Grand Plaza Hotel","TripAdvisor","2024-01-15"
"Poor experience, room was dirty and staff was rude.","Disappointing Experience",2,"Jane Smith","London, UK","Grand Plaza Hotel","Booking.com","2024-01-16"
"Average hotel, nothing special but adequate for the price.","Average Hotel",3,"Mike Johnson","Toronto, Canada","Grand Plaza Hotel","Hotels.com","2024-01-17"`;
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sample_reviews.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Real-time upload progress (would be implemented with WebSockets in production)
function updateProcessingQueue() {
    // This would fetch actual processing status from the server
    console.log('Updating processing queue...');
}

// Check for processing updates every 5 seconds
setInterval(updateProcessingQueue, 5000);
</script>
{% endblock %}
