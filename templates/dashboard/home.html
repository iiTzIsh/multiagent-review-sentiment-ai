{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - Hotel Review Insight Platform{% endblock %}

{% block page_icon %}<i class="fas fa-tachometer-alt me-2"></i>{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block page_description %}
<p class="page-description">Multi agent review analysis and insights dashboard</p>
{% endblock %}

{% block extra_css %}
<style>
    /* Recent Uploads Section Text Visibility */
    .card-body .border-bottom {
        border-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    .card-body h6 {
        color: #ffffff !important;
    }
    
    .card-body .text-light {
        color: #e5e7eb !important;
    }
    
    .card-body .text-muted {
        color: #9ca3af !important;
    }
</style>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2 flex-wrap">
    <a href="{% url 'dashboard:upload_reviews' %}" class="btn btn-primary" data-bs-toggle="tooltip" title="Upload new review data">
        <i class="fas fa-upload me-1"></i>Upload Reviews
    </a>
    <button id="process-reviews-btn" class="btn btn-success" data-bs-toggle="tooltip" title="Process uploaded reviews with AI">
        <i class="fas fa-cog me-1"></i>Process Reviews
    </button>
    <button class="btn btn-outline-primary" data-bs-toggle="tooltip" title="Refresh dashboard data">
        <i class="fas fa-sync-alt me-1"></i>Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-primary text-white fade-in">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ total_reviews|floatformat:0 }}</div>
                    <div class="metric-label">Total Reviews</div>
                </div>
                <div class="opacity-75">
                    <i class="fas fa-comments fa-2x"></i>
                </div>
            </div>
            <div class="mt-3">
                <small class="opacity-90">
                    <i class="fas fa-arrow-up me-1"></i>12% from last month
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-success text-white fade-in" style="animation-delay: 0.1s">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ processed_reviews|floatformat:0 }}</div>
                    <div class="metric-label">Processed Reviews</div>
                </div>
                <div class="opacity-75">
                    <i class="fas fa-robot fa-2x"></i>
                </div>
            </div>
            <div class="mt-3">
                <small class="opacity-90">
                    <i class="fas fa-check me-1"></i>AI Analysis Complete
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-info text-white fade-in" style="animation-delay: 0.2s">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ total_hotels|floatformat:0 }}</div>
                    <div class="metric-label">Hotels Analyzed</div>
                </div>
                <div class="opacity-75">
                    <i class="fas fa-building fa-2x"></i>
                </div>
            </div>
            <div class="mt-3">
                <small class="opacity-90">
                    <i class="fas fa-globe me-1"></i>Across multiple regions
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="metric-card bg-warning text-white fade-in" style="animation-delay: 0.3s">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ processing_rate|floatformat:1 }}%</div>
                    <div class="metric-label">Processing Rate</div>
                </div>
                <div class="opacity-75">
                    <i class="fas fa-percentage fa-2x"></i>
                </div>
            </div>
            <div class="mt-3">
                <small class="opacity-90">
                    <i class="fas fa-clock me-1"></i>Real-time processing
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Analysis Row -->
<div class="row g-4 mb-4">
    <div class="col-xl-6">
        <div class="card fade-in-scale">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2 text-primary"></i>Sentiment Distribution
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-download me-2"></i>Export Chart</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-expand me-2"></i>View Full Screen</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="sentimentChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Score Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="scoreChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>Recent Reviews
                </h5>
                <a href="{% url 'dashboard:reviews_list' %}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="card-body">
                {% if recent_reviews %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Hotel</th>
                                    <th>Sentiment</th>
                                    <th>Score</th>
                                    <th>Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for review in recent_reviews %}
                                <tr>
                                    <td>{{ review.hotel.name|truncatechars:30 }}</td>
                                    <td>
                                        <span class="badge bg-{% if review.sentiment == 'positive' %}success{% elif review.sentiment == 'negative' %}danger{% else %}warning{% endif %}">
                                            {{ review.sentiment|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">{{ review.ai_score|floatformat:1 }}</span>
                                            <div class="progress" style="width: 60px; height: 8px;">
                                                <div class="progress-bar progress-bar-score" 
                                                     data-score="{{ review.ai_score }}"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ review.created_at|date:"M d, Y" }}</td>
                                    <td>
                                        <a href="{% url 'dashboard:review_detail' review.id %}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No reviews available. <a href="{% url 'dashboard:upload_reviews' %}">Upload some reviews</a> to get started.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>Recent Uploads
                </h5>
            </div>
            <div class="card-body">
                {% if recent_batches %}
                    {% for batch in recent_batches|slice:":5" %}
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                        <div>
                            <h6 class="mb-1 text-white">{{ batch.file_name|truncatechars:25 }}</h6>
                            <small class="text-light">
                                {{ batch.processed_reviews }}/{{ batch.total_reviews }} processed
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-{% if batch.status == 'completed' %}success{% elif batch.status == 'failed' %}danger{% elif batch.status == 'processing' %}warning{% else %}secondary{% endif %}">
                                {{ batch.status|title }}
                            </span>
                            <br>
                            <small class="text-light">{{ batch.upload_date|timesince }} ago</small>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="text-center">
                        <a href="{% url 'dashboard:upload_reviews' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>Upload More
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-light py-3">
                        <i class="fas fa-upload fa-2x mb-2"></i>
                        <p class="mb-0">No uploads yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Agent Status Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>AI Agent Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="agent-status">
                            <i class="fas fa-brain fa-2x text-primary mb-2"></i>
                            <h6>Classifier</h6>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="agent-status">
                            <i class="fas fa-star fa-2x text-warning mb-2"></i>
                            <h6>Scorer</h6>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="agent-status">
                            <i class="fas fa-compress-alt fa-2x text-info mb-2"></i>
                            <h6>Summarizer</h6>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="agent-status">
                            <i class="fas fa-search fa-2x text-success mb-2"></i>
                            <h6>Search</h6>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="agent-status">
                            <i class="fas fa-shield-alt fa-2x text-danger mb-2"></i>
                            <h6>Security</h6>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="agent-status">
                            <i class="fas fa-sitemap fa-2x text-secondary mb-2"></i>
                            <h6>Orchestrator</h6>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart data as JSON -->
{{ sentiment_data|json_script:"sentiment-chart-data" }}
{{ score_data|json_script:"score-chart-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Get chart data from JSON scripts
function getSafeJsonData(elementId) {
    const element = document.getElementById(elementId);
    if (element && element.textContent) {
        try {
            return JSON.parse(element.textContent);
        } catch (e) {
            console.warn('Failed to parse JSON data for', elementId);
            return null;
        }
    }
    return null;
}

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeHomeCharts();
    initializeProgressBars();
    
    // Note: Process reviews button event listener is handled by enhanced-dashboard.js
    // No need to set up duplicate event listener here
});

function initializeProgressBars() {
    // Set progress bar widths based on AI scores
    const progressBars = document.querySelectorAll('.progress-bar-score');
    progressBars.forEach(function(bar) {
        const score = parseFloat(bar.dataset.score) || 0;
        const percentage = Math.round((score / 5) * 100);
        bar.style.width = percentage + '%';
        
        // Add color based on score
        if (score >= 4) {
            bar.classList.add('bg-success');
        } else if (score >= 3) {
            bar.classList.add('bg-warning');
        } else {
            bar.classList.add('bg-danger');
        }
    });
}

function initializeHomeCharts() {
    const sentimentData = getSafeJsonData('sentiment-chart-data');
    const scoreData = getSafeJsonData('score-chart-data');

    // Sentiment Distribution Chart
    const sentimentCtx = document.getElementById('sentimentChart');
    if (sentimentCtx && sentimentData) {

        const sentimentLabels = sentimentData.map(item => item.sentiment.charAt(0).toUpperCase() + item.sentiment.slice(1));
        const sentimentCounts = sentimentData.map(item => item.count);
        const sentimentColors = sentimentLabels.map(label => {
            if (label.toLowerCase() === 'positive') return '#28a745';
            if (label.toLowerCase() === 'negative') return '#dc3545';
            return '#ffc107';
        });

        new Chart(sentimentCtx, {
            type: 'doughnut',
            data: {
                labels: sentimentLabels,
                datasets: [{
                    data: sentimentCounts,
                    backgroundColor: sentimentColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    } else {
        sentimentCtx.parentNode.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-chart-pie fa-3x mb-2"></i><br>No sentiment data available</div>';
    }

    // Score Distribution Chart
    const scoreCtx = document.getElementById('scoreChart');
    if (scoreCtx) {
        console.log('Score data received:', scoreData);
        
        if (scoreData && Array.isArray(scoreData) && scoreData.some(val => val > 0)) {
            const scoreLabels = ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'];
            
            new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: scoreLabels,
                    datasets: [{
                        label: 'Number of Reviews',
                        data: scoreData,
                        backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#28a745'],
                        borderRadius: 4,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(156, 163, 175, 0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        } else {
            // Show placeholder when no data
            scoreCtx.parentNode.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-chart-bar fa-3x mb-2"></i><br>No score data available<br><small>Upload and process some reviews to see score distribution</small></div>';
        }
    } else {
        console.error('Score chart canvas not found');
    }
}

// Note: processReviews() function is implemented in enhanced-dashboard.js
// It uses the correct API endpoint /api/v1/process/ instead of dashboard endpoint



// Load charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCharts();
});
</script>
{% endblock %}
